!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.WebRTCMetrics=e():t.WebRTCMetrics=e()}(self,(()=>(()=>{var t={43:function(t,e,a){var s,i;!function(o,r){"use strict";s=function(){var t=function(){},e="undefined",a=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),s=["trace","debug","info","warn","error"];function i(t,e){var a=t[e];if("function"==typeof a.bind)return a.bind(t);try{return Function.prototype.bind.call(a,t)}catch(e){return function(){return Function.prototype.apply.apply(a,[t,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function r(s){return"debug"===s&&(s="log"),typeof console!==e&&("trace"===s&&a?o:void 0!==console[s]?i(console,s):void 0!==console.log?i(console,"log"):t)}function n(e,a){for(var i=0;i<s.length;i++){var o=s[i];this[o]=i<e?t:this.methodFactory(o,e,a)}this.log=this.debug}function l(t,a,s){return function(){typeof console!==e&&(n.call(this,a,s),this[t].apply(this,arguments))}}function _(t,e,a){return r(t)||l.apply(this,arguments)}function c(t,a,i){var o,r=this;a=null==a?"WARN":a;var l="loglevel";function c(){var t;if(typeof window!==e&&l){try{t=window.localStorage[l]}catch(t){}if(typeof t===e)try{var a=window.document.cookie,s=a.indexOf(encodeURIComponent(l)+"=");-1!==s&&(t=/^([^;]+)/.exec(a.slice(s))[1])}catch(t){}return void 0===r.levels[t]&&(t=void 0),t}}"string"==typeof t?l+=":"+t:"symbol"==typeof t&&(l=void 0),r.name=t,r.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},r.methodFactory=i||_,r.getLevel=function(){return o},r.setLevel=function(a,i){if("string"==typeof a&&void 0!==r.levels[a.toUpperCase()]&&(a=r.levels[a.toUpperCase()]),!("number"==typeof a&&a>=0&&a<=r.levels.SILENT))throw"log.setLevel() called with invalid level: "+a;if(o=a,!1!==i&&function(t){var a=(s[t]||"silent").toUpperCase();if(typeof window!==e&&l){try{return void(window.localStorage[l]=a)}catch(t){}try{window.document.cookie=encodeURIComponent(l)+"="+a+";"}catch(t){}}}(a),n.call(r,a,t),typeof console===e&&a<r.levels.SILENT)return"No console available for logging"},r.setDefaultLevel=function(t){a=t,c()||r.setLevel(t,!1)},r.resetLevel=function(){r.setLevel(a,!1),function(){if(typeof window!==e&&l){try{return void window.localStorage.removeItem(l)}catch(t){}try{window.document.cookie=encodeURIComponent(l)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(t){}}}()},r.enableAll=function(t){r.setLevel(r.levels.TRACE,t)},r.disableAll=function(t){r.setLevel(r.levels.SILENT,t)};var u=c();null==u&&(u=a),r.setLevel(u,!1)}var u=new c,d={};u.getLogger=function(t){if("symbol"!=typeof t&&"string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=d[t];return e||(e=d[t]=new c(t,u.getLevel(),u.methodFactory)),e};var p=typeof window!==e?window.log:void 0;return u.noConflict=function(){return typeof window!==e&&window.log===u&&(window.log=p),u},u.getLoggers=function(){return d},u.default=u,u},void 0===(i=s.call(e,a,e,t))||(t.exports=i)}()},666:t=>{var e=function(t){"use strict";var e,a=Object.prototype,s=a.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",r=i.asyncIterator||"@@asyncIterator",n=i.toStringTag||"@@toStringTag";function l(t,e,a){return Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,a){return t[e]=a}}function _(t,e,a,s){var i=e&&e.prototype instanceof y?e:y,o=Object.create(i.prototype),r=new B(s||[]);return o._invoke=function(t,e,a){var s=u;return function(i,o){if(s===p)throw new Error("Generator is already running");if(s===h){if("throw"===i)throw o;return O()}for(a.method=i,a.arg=o;;){var r=a.delegate;if(r){var n=S(r,a);if(n){if(n===m)continue;return n}}if("next"===a.method)a.sent=a._sent=a.arg;else if("throw"===a.method){if(s===u)throw s=h,a.arg;a.dispatchException(a.arg)}else"return"===a.method&&a.abrupt("return",a.arg);s=p;var l=c(t,e,a);if("normal"===l.type){if(s=a.done?h:d,l.arg===m)continue;return{value:l.arg,done:a.done}}"throw"===l.type&&(s=h,a.method="throw",a.arg=l.arg)}}}(t,a,r),o}function c(t,e,a){try{return{type:"normal",arg:t.call(e,a)}}catch(t){return{type:"throw",arg:t}}}t.wrap=_;var u="suspendedStart",d="suspendedYield",p="executing",h="completed",m={};function y(){}function v(){}function f(){}var g={};g[o]=function(){return this};var b=Object.getPrototypeOf,k=b&&b(b(L([])));k&&k!==a&&s.call(k,o)&&(g=k);var w=f.prototype=y.prototype=Object.create(g);function C(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function a(i,o,r,n){var l=c(t[i],t,o);if("throw"!==l.type){var _=l.arg,u=_.value;return u&&"object"==typeof u&&s.call(u,"__await")?e.resolve(u.__await).then((function(t){a("next",t,r,n)}),(function(t){a("throw",t,r,n)})):e.resolve(u).then((function(t){_.value=t,r(_)}),(function(t){return a("throw",t,r,n)}))}n(l.arg)}var i;this._invoke=function(t,s){function o(){return new e((function(e,i){a(t,s,e,i)}))}return i=i?i.then(o,o):o()}}function S(t,a){var s=t.iterator[a.method];if(s===e){if(a.delegate=null,"throw"===a.method){if(t.iterator.return&&(a.method="return",a.arg=e,S(t,a),"throw"===a.method))return m;a.method="throw",a.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var i=c(s,t.iterator,a.arg);if("throw"===i.type)return a.method="throw",a.arg=i.arg,a.delegate=null,m;var o=i.arg;return o?o.done?(a[t.resultName]=o.value,a.next=t.nextLoc,"return"!==a.method&&(a.method="next",a.arg=e),a.delegate=null,m):o:(a.method="throw",a.arg=new TypeError("iterator result is not an object"),a.delegate=null,m)}function R(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function j(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function B(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(R,this),this.reset(!0)}function L(t){if(t){var a=t[o];if(a)return a.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,r=function a(){for(;++i<t.length;)if(s.call(t,i))return a.value=t[i],a.done=!1,a;return a.value=e,a.done=!0,a};return r.next=r}}return{next:O}}function O(){return{value:e,done:!0}}return v.prototype=w.constructor=f,f.constructor=v,v.displayName=l(f,n,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===v||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,l(t,n,"GeneratorFunction")),t.prototype=Object.create(w),t},t.awrap=function(t){return{__await:t}},C(x.prototype),x.prototype[r]=function(){return this},t.AsyncIterator=x,t.async=function(e,a,s,i,o){void 0===o&&(o=Promise);var r=new x(_(e,a,s,i),o);return t.isGeneratorFunction(a)?r:r.next().then((function(t){return t.done?t.value:r.next()}))},C(w),l(w,n,"Generator"),w[o]=function(){return this},w.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var a in t)e.push(a);return e.reverse(),function a(){for(;e.length;){var s=e.pop();if(s in t)return a.value=s,a.done=!1,a}return a.done=!0,a}},t.values=L,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(j),!t)for(var a in this)"t"===a.charAt(0)&&s.call(this,a)&&!isNaN(+a.slice(1))&&(this[a]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var a=this;function i(s,i){return n.type="throw",n.arg=t,a.next=s,i&&(a.method="next",a.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var r=this.tryEntries[o],n=r.completion;if("root"===r.tryLoc)return i("end");if(r.tryLoc<=this.prev){var l=s.call(r,"catchLoc"),_=s.call(r,"finallyLoc");if(l&&_){if(this.prev<r.catchLoc)return i(r.catchLoc,!0);if(this.prev<r.finallyLoc)return i(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return i(r.catchLoc,!0)}else{if(!_)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return i(r.finallyLoc)}}}},abrupt:function(t,e){for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a];if(i.tryLoc<=this.prev&&s.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var r=o?o.completion:{};return r.type=t,r.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(r)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var a=this.tryEntries[e];if(a.finallyLoc===t)return this.complete(a.completion,a.afterLoc),j(a),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var a=this.tryEntries[e];if(a.tryLoc===t){var s=a.completion;if("throw"===s.type){var i=s.arg;j(a)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,a,s){return this.delegate={iterator:L(t),resultName:a,nextLoc:s},"next"===this.method&&(this.arg=e),m}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}},913:t=>{var e=(()=>{var t=Object.defineProperty,e=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s,o=(t,o)=>{for(var r in o||(o={}))a.call(o,r)&&i(t,r,o[r]);if(e)for(var r of e(o))s.call(o,r)&&i(t,r,o[r]);return t},r={};((e,a)=>{for(var s in(e=>{t(e,"__esModule",{value:!0})})(e),a)t(e,s,{get:a[s],enumerable:!0})})(r,{DEFAULT_UUID_LENGTH:()=>n,default:()=>c});var n=6,l={dictionary:"alphanum",shuffle:!0,debug:!1,length:n},_=class extends Function{constructor(t={}){super(),this.dictIndex=0,this.dictRange=[],this.lowerBound=0,this.upperBound=0,this.dictLength=0,this._digit_first_ascii=48,this._digit_last_ascii=58,this._alpha_lower_first_ascii=97,this._alpha_lower_last_ascii=123,this._hex_last_ascii=103,this._alpha_upper_first_ascii=65,this._alpha_upper_last_ascii=91,this._number_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii]},this._alpha_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alpha_lower_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alpha_upper_dict_ranges={upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_lower_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alphanum_upper_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._hex_dict_ranges={decDigits:[this._digit_first_ascii,this._digit_last_ascii],alphaDigits:[this._alpha_lower_first_ascii,this._hex_last_ascii]},this.log=(...t)=>{const e=[...t];if(e[0]=`[short-unique-id] ${t[0]}`,!0===this.debug&&"undefined"!=typeof console&&null!==console)return console.log(...e)},this.setDictionary=(t,e)=>{let a;if(t&&Array.isArray(t)&&t.length>1)a=t;else{let e;a=[],this.dictIndex=e=0;const s=this[`_${t}_dict_ranges`];Object.keys(s).forEach((t=>{const i=t;for(this.dictRange=s[i],this.lowerBound=this.dictRange[0],this.upperBound=this.dictRange[1],this.dictIndex=e=this.lowerBound;this.lowerBound<=this.upperBound?e<this.upperBound:e>this.upperBound;this.dictIndex=this.lowerBound<=this.upperBound?e+=1:e-=1)a.push(String.fromCharCode(this.dictIndex))}))}if(e){const t=.5;a=a.sort((()=>Math.random()-t))}this.dict=a,this.dictLength=this.dict.length,this.counter=0},this.seq=()=>this.sequentialUUID(),this.sequentialUUID=()=>{let t,e,a="";t=this.counter;do{e=t%this.dictLength,t=Math.trunc(t/this.dictLength),a+=this.dict[e]}while(0!==t);return this.counter+=1,a},this.randomUUID=(t=this.uuidLength||n)=>{let e,a,s;if(null==t||t<1)throw new Error("Invalid UUID Length Provided");for(e="",s=0;s<t;s+=1)a=parseInt((Math.random()*this.dictLength).toFixed(0),10)%this.dictLength,e+=this.dict[a];return e},this.availableUUIDs=(t=this.uuidLength)=>parseFloat(Math.pow([...new Set(this.dict)].length,t).toFixed(0)),this.approxMaxBeforeCollision=(t=this.availableUUIDs(this.uuidLength))=>parseFloat(Math.sqrt(Math.PI/2*t).toFixed(20)),this.collisionProbability=(t=this.availableUUIDs(this.uuidLength),e=this.uuidLength)=>parseFloat((this.approxMaxBeforeCollision(t)/this.availableUUIDs(e)).toFixed(20)),this.uniqueness=(t=this.availableUUIDs(this.uuidLength))=>{const e=parseFloat((1-this.approxMaxBeforeCollision(t)/t).toFixed(20));return e>1?1:e<0?0:e},this.getVersion=()=>this.version,this.stamp=t=>{if("number"!=typeof t||t<10)throw new Error("Param finalLength must be number greater than 10");const e=Math.floor(+new Date/1e3).toString(16),a=t-9,s=Math.round(Math.random()*(a>15?15:a)),i=this.randomUUID(a);return`${i.substr(0,s)}${e}${i.substr(s)}${s.toString(16)}`},this.parseStamp=t=>{if(t.length<10)throw new Error("Stamp length invalid");const e=parseInt(t.substr(t.length-1,1),16);return new Date(1e3*parseInt(t.substr(e,8),16))};const e=o(o({},l),t);this.counter=0,this.debug=!1,this.dict=[],this.version="4.4.4";const{dictionary:a,shuffle:s,length:i}=e;return this.uuidLength=i,this.setDictionary(a,s),this.debug=e.debug,this.log(this.dict),this.log(`Generator instantiated with Dictionary Size ${this.dictLength}`),new Proxy(this,{apply:(t,e,a)=>this.randomUUID(...a)})}},c=_;return c.default=_,r})();t.exports=e.default,"undefined"!=typeof window&&(e=e.default)}},e={};function a(s){var i=e[s];if(void 0!==i)return i.exports;var o=e[s]={exports:{}};return t[s].call(o.exports,o,o.exports,a),o.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var s={};return(()=>{"use strict";a.d(s,{default:()=>At}),a(666);var t=a(43);const e=()=>`${(new Date).toISOString()} | metrics`,i=(t,e,a)=>`${t} | ${e} | ${a}`;t.setDefaultLevel(t.levels.TRACE);const o=(a,s,o)=>{o?t.debug(i(e(),a,s),o):t.debug(i(e(),a,s))},r=(a,s)=>{t.info(i(e(),a,s))},n=(a,s)=>{t.info(i(e(),a,s))},l=(a,s)=>{t.warn(i(e(),a,s))},_=(a,s)=>{t.error(i(e(),a,s))};var c=a(913),u=a.n(c);const d=new(u()),p="inbound",h="outbound",m="idle",y="running",v={level_in:0,codec_id_in:"",codec_in:{mime_type:null,clock_rate:null,sdp_fmtp_line:null},track_in:"",ssrc:"",direction:p,delta_jitter_ms_in:0,delta_rtt_ms_in:null,delta_packets_in:0,delta_packets_lost_in:0,delta_KBytes_in:0,delta_kbs_in:0,delta_synthetized_ms_in:0,delta_playout_delay_ms_in:0,delta_jitter_buffer_delay_ms_in:0,total_rtt_ms_in:0,total_rtt_measure_in:0,total_packets_in:0,total_packets_lost_in:0,total_KBytes_in:0,total_percent_synthetized_in:0,total_synthetized_ms_in:0,total_playout_ms_in:0,total_time_jitter_buffer_delay_in:0,total_jitter_emitted_in:0,percent_synthetized_in:0,timestamp_in:null,mos_in:1,mos_emodel_in:1,mos_fullband_in:1,percent_packets_lost_in:0},f={active_out:null,level_out:0,codec_id_out:"",codec_out:{mime_type:null,clock_rate:null,sdp_fmtp_line:null},track_out:"",device_out:"",ssrc:"",direction:h,delta_jitter_ms_out:0,delta_rtt_ms_out:null,delta_packet_delay_ms_out:0,delta_packets_lost_out:0,delta_packets_out:0,delta_KBytes_out:0,delta_kbs_out:0,percent_packets_lost_out:0,total_rtt_ms_out:0,total_rtt_measure_out:0,total_time_packets_delay_out:0,total_packets_lost_out:0,total_packets_out:0,total_KBytes_out:0,timestamp_out:null,mos_out:1,mos_emodel_out:1,mos_fullband_out:1},g={codec_id_in:"",codec_in:{mime_type:null,clock_rate:null},direction:p,decoder_in:null,track_in:"",ssrc:"",size_in:{width:0,height:0,framerate:0},delta_jitter_ms_in:0,delta_packets_in:0,delta_packets_lost_in:0,delta_KBytes_in:0,delta_kbs_in:0,delta_glitch_in:{freeze:0,pause:0},delta_decode_frame_ms_in:0,delta_processing_delay_ms_in:0,delta_assembly_delay_ms_in:0,delta_nack_sent_in:0,delta_pli_sent_in:0,delta_jitter_buffer_delay_ms_in:0,percent_packets_lost_in:0,total_packets_in:0,total_packets_lost_in:0,total_KBytes_in:0,total_glitch_in:{freeze:0,pause:0},total_frames_decoded_in:0,total_time_decoded_in:0,total_time_processing_delay_in:0,total_time_assembly_delay_in:0,total_time_jitter_buffer_delay_in:0,total_jitter_emitted_in:0,total_nack_sent_in:0,total_pli_sent_in:0},b={active_out:null,codec_id_out:"",codec_out:{mime_type:null,clock_rate:null},track_out:"",device_out:"",ssrc:"",direction:h,encoder_out:null,size_out:{width:0,height:0,framerate:0},size_pref_out:{width:0,height:0,framerate:0},delta_jitter_ms_out:0,delta_rtt_ms_out:null,delta_packet_delay_ms_out:0,delta_packets_lost_out:0,delta_packets_out:0,delta_KBytes_out:0,delta_kbs_out:0,delta_encode_frame_ms_out:0,delta_nack_received_out:0,delta_pli_received_out:0,total_rtt_ms_out:0,total_rtt_measure_out:0,total_time_packets_delay_out:0,total_packets_lost_out:0,total_packets_out:0,total_KBytes_out:0,total_time_encoded_out:0,total_frames_encoded_out:0,total_nack_received_out:0,total_pli_received_out:0,percent_packets_lost_out:0,limitation_out:{reason:null,durations:null,resolutionChanges:0},timestamp_out:null},k={refreshEvery:2e3,startAfter:0,stopAfter:-1,verbose:!1,pname:`p-${d()}`,cid:`c-${d()}`,uid:`u-${d()}`,record:!1,ticket:!0,passthrough:{}},w="inbound-rtp",C="bytesReceived",x="currentRoundTripTime",S="fractionLost",R="frameHeight",j="frameWidth",B="framesDecoded",L="framesEncoded",O="freezeCount",T="qualityLimitationReason",N="qualityLimitationDurations",K="qualityLimitationResolutionChanges",E="jitter",P="nackCount",I="networkType",$="packetsLost",D="packetsReceived",z="pauseCount",M="pliCount",A="responsesReceived",F="roundTripTime",U="selected",J="totalDecodeTime",q="totalEncodeTime",G="totalRoundTripTime",W="roundTripTimeMeasurements",H="audio",Y="video",V="data",Q="audio",X="video",Z="network",tt="data",et="config      ",at=new(u()),st=(t,e,a,s=!1,i=null,o=!1)=>{let r=t.map((t=>{if(!a)return o?{timestamp:new Date(t.timestamp).toJSON(),value:t[e]}:t[e];if(!i)return o?{timestamp:new Date(t.timestamp).toJSON(),value:t[e][a]}:t[e][a];const s=t[e][i];return s?o?{timestamp:new Date(t.timestamp).toJSON(),value:s[a]}:s[a]:null}));return r=r.filter((t=>o?s?t&&Number.isFinite(t.value)&&t.value>0:t&&Number.isFinite(t.value):s?Number.isFinite(t)&&t>0:Number.isFinite(t))),0===r.length?[]:r},it=(t,e)=>{const a=t.filter((t=>null!==t));return a.length>0?a.reduce(((t,e)=>t+e),0)/t.length:e},ot=t=>new Promise((e=>{setTimeout(e,t)})),rt=(t,e,a)=>{e?t.call(e,a):t(a)},nt=(t,e,a,s)=>{const i=st(t,e,a,!0,s);if(0===i.length)return null;const o=i.reduce(((t,e)=>t+e),0)/i.length;return 0===o?null:i.map((t=>Math.abs(o-t))).reduce(((t,e)=>t+e),0)/i.length*100/o},lt=(t,e,a,s=!1,i=null)=>{const o=st(t,e,a,s,i);return 0===o.length?null:o.reduce(((t,e)=>t+e),0)/o.length},_t=(t,e,a)=>st(t,e,a).reduce(((t,e)=>t+e),0),ct=(t,e,a,s)=>{const i=st(t,e,a,!0,s);return 0===i.length?null:Math.min(...i)},ut=(t,e,a,s)=>{const i=st(t,e,a,!1,s);return 0===i.length?null:Math.max(...i)},dt=(t,e,a,s)=>st(t,e,a,!1,s,!0),pt=(t,e,a,s)=>{const i=t.slice().pop();if(!i)return null;if(!a)return i[e];if(!s)return i[e][a];const o=i[e][s];return o?o[a]:null},ht=(t,e,a)=>{if(!e)return null;const s={};let i=e.audio[t];i||(i=a===p?{...v}:{...f}),s.audio=i;let o=e.video[t];return o||(o=a===p?{...g}:{...b}),s.video=o,s},mt=(t,e)=>{const a=e.getSenders().find((e=>e.track&&e.track.kind===t));return a?a.track:null},yt="exporter    ",vt=(t,e,a,s=!1)=>{if(!t||0===t.length)return 0;const i=t[t.length-1];if(!i)return 0;const o=i[e][a];if(o){const i=s?o.total_rtt_ms_in:o.total_rtt_ms_out,r=s?o.total_rtt_measure_in:o.total_rtt_measure_out;return r&&i?Number(i/r):lt(t,e,s?"delta_rtt_ms_in":"delta_rtt_ms_out",!1,a)}return null},ft=(t,e)=>{if(!t||0===t.length)return 0;const a=t[t.length-1];if(!a)return 0;const s=a[e].total_rtt_connectivity_ms,i=a[e].total_rtt_connectivity_measure;return i&&s?Number(s/i):lt(t,e,"delta_rtt_connectivity_ms")},gt=t=>{const e=pt(t,"network","remote_candidate_type"),a=pt(t,"network","remote_candidate_protocol");return"relay"!==e?`direct/${a}`:`turn/${a}`};class bt{constructor(t){this._start=null,this._end=null,this._cfg=t,this._referenceReport=null,this._reports=[],this._events=[]}start(){r(yt,"start() - start exporter...");const t=new Date;return this._start=t.toJSON(),t}stop(){r(yt,"stop() - stop exporter...");const t=new Date;return this._end=t.toJSON(),t}saveReferenceReport(t){this._referenceReport=t}getReferenceReport(){return this._referenceReport}addReport(t){this._cfg.ticket&&(o(yt,`addReport() - add report to exporter at ${t.timestamp}`),this._reports.push(t))}addCustomEvent(t){this._events.push(t)}reset(){r(yt,"resetReports() - reset reports"),this._reports=[],this._referenceReport=null,this._start=null,this._end=null}generateTicket(){o(yt,"ticket() - generate ticket");const t=pt(this._reports,"audio","total_packets_lost_in"),e=pt(this._reports,"audio","total_packets_in"),a=pt(this._reports,"video","total_packets_lost_in"),s=pt(this._reports,"video","total_packets_in"),i={},r=this._reports.slice().pop();return r&&(Object.keys(r.audio).forEach((t=>{const e=r.audio[t];if(i[e.ssrc]={type:H,direction:e.direction},e.direction===p){const e={avg:lt(this._reports,H,"delta_jitter_ms_in",!1,t),min:ct(this._reports,H,"delta_jitter_ms_in",t),max:ut(this._reports,H,"delta_jitter_ms_in",t),volatility:nt(this._reports,H,"delta_jitter_ms_in",t),values:dt(this._reports,H,"delta_jitter_ms_in",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},a={avg:lt(this._reports,H,"delta_kbs_in",!1,t),min:ct(this._reports,H,"delta_kbs_in",t),max:ut(this._reports,H,"delta_kbs_in",t),volatility:nt(this._reports,H,"delta_kbs_in",t),values:dt(this._reports,H,"delta_kbs_in",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},s={avg:lt(this._reports,H,"delta_KBytes_in",!1,t),min:ct(this._reports,H,"delta_KBytes_in",t),max:ut(this._reports,H,"delta_KBytes_in",t),volatility:nt(this._reports,H,"delta_KBytes_in",t),values:dt(this._reports,H,"delta_KBytes_in",t),_unit:{avg:"KB",min:"KB",max:"KB",volatility:"percent"}},o={emodel:{avg:lt(this._reports,H,"mos_fullband_in",!1,t),min:ct(this._reports,H,"mos_fullband_in",t),max:ut(this._reports,H,"mos_fullband_in",t),volatility:nt(this._reports,H,"mos_fullband_in",t),values:dt(this._reports,H,"mos_fullband_in",t)},effective:{avg:lt(this._reports,H,"mos_in",!1,t),min:ct(this._reports,H,"mos_in",t),max:ut(this._reports,H,"mos_in",t),volatility:nt(this._reports,H,"mos_in",t),values:dt(this._reports,H,"mos_in",t)},_unit:{avg:"number (1-5)",min:"number (1-5)",max:"number (1-5)",volatility:"percent"}},r=pt(this._reports,H,"total_packets_lost_in",t),n=pt(this._reports,H,"total_packets_in",t),l={lost:r,avg:Math.round(100*(r/(r+n)*100||0))/100,values:dt(this._reports,H,"delta_packets_lost_in",t),_unit:{avg:"percent",lost:"number"}},_={avg:vt(this._reports,H,t,!0),min:ct(this._reports,H,"delta_rtt_ms_in",t),max:ut(this._reports,H,"delta_rtt_ms_in",t),volatility:nt(this._reports,H,"delta_rtt_ms_in",t),values:dt(this._reports,H,"delta_rtt_ms_in",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}};i[t].jitter=e,i[t].rtt=_,i[t].mos=o,i[t].traffic=s,i[t].bitrate=a,i[t].loss=l}else{const e={avg:lt(this._reports,H,"delta_jitter_ms_out",!1,t),min:ct(this._reports,H,"delta_jitter_ms_out",t),max:ut(this._reports,H,"delta_jitter_ms_out",t),volatility:nt(this._reports,H,"delta_jitter_ms_out",t),values:dt(this._reports,H,"delta_jitter_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},a={avg:lt(this._reports,H,"delta_kbs_out",!1,t),min:ct(this._reports,H,"delta_kbs_out",t),max:ut(this._reports,H,"delta_kbs_out",t),volatility:nt(this._reports,H,"delta_kbs_out",t),values:dt(this._reports,H,"delta_kbs_out",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},s={avg:lt(this._reports,H,"delta_KBytes_out",!1,t),min:ct(this._reports,H,"delta_KBytes_out",t),max:ut(this._reports,H,"delta_KBytes_out",t),volatility:nt(this._reports,H,"delta_KBytes_out",t),values:dt(this._reports,H,"delta_KBytes_out",t),_unit:{avg:"KB",min:"KB",max:"KB",bitrate:"kbs",volatility:"percent"}},o={avg:vt(this._reports,H,t),min:ct(this._reports,H,"delta_rtt_ms_out",t),max:ut(this._reports,H,"delta_rtt_ms_out",t),volatility:nt(this._reports,H,"delta_rtt_ms_out",t),values:dt(this._reports,H,"delta_rtt_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},r=pt(this._reports,H,"total_packets_lost_out",t),n=pt(this._reports,H,"total_packets_out",t),l={lost:r,avg:Math.round(100*(r/(r+n)*100||0))/100,values:dt(this._reports,H,"delta_packets_lost_out",t),_unit:{avg:"percent",lost:"number"}},_={emodel:{avg:lt(this._reports,H,"mos_fullband_out",!1,t),min:ct(this._reports,H,"mos_fullband_out",t),max:ut(this._reports,H,"mos_fullband_out",t),volatility:nt(this._reports,H,"mos_fullband_out",t),values:dt(this._reports,H,"mos_fullband_out",t)},effective:{avg:lt(this._reports,H,"mos_out",!1,t),min:ct(this._reports,H,"mos_out",t),max:ut(this._reports,H,"mos_out",t),volatility:nt(this._reports,H,"mos_out",t),values:dt(this._reports,H,"mos_out",t)},_unit:{avg:"number (1-5)",min:"number (1-5)",max:"number (1-5)",volatility:"percent"}};i[t].jitter=e,i[t].rtt=o,i[t].traffic=s,i[t].bitrate=a,i[t].loss=l,i[t].mos=_}})),Object.keys(r.video).forEach((t=>{const e=r.video[t];if(i[t]={type:Y,direction:e.direction},e.direction===p){const e={avg:lt(this._reports,Y,"delta_jitter_ms_in",!1,t),min:ct(this._reports,Y,"delta_jitter_ms_in",t),max:ut(this._reports,Y,"delta_jitter_ms_in",t),volatility:nt(this._reports,Y,"delta_jitter_ms_in",t),values:dt(this._reports,Y,"delta_jitter_ms_in",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},a={avg:lt(this._reports,Y,"delta_kbs_in",!1,t),min:ct(this._reports,Y,"delta_kbs_in",t),max:ut(this._reports,Y,"delta_kbs_in",t),volatility:nt(this._reports,Y,"delta_kbs_in",t),values:dt(this._reports,Y,"delta_kbs_in",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},s={avg:lt(this._reports,Y,"delta_KBytes_in",!1,t),min:ct(this._reports,Y,"delta_KBytes_in",t),max:ut(this._reports,Y,"delta_KBytes_in",t),volatility:nt(this._reports,Y,"delta_KBytes_in",t),values:dt(this._reports,Y,"delta_KBytes_in",t),_unit:{avg:"KB",min:"KB",max:"KB",volatility:"percent"}},o=pt(this._reports,Y,"total_packets_lost_in",t),r=pt(this._reports,Y,"total_packets_in",t),n={lost:o,avg:Math.round(100*(o/(o+r)*100||0))/100,values:dt(this._reports,Y,"delta_packets_lost_in",t),_unit:{avg:"percent",lost:"number"}};i[t].jitter=e,i[t].traffic=s,i[t].bitrate=a,i[t].loss=n}else{const e={avg:lt(this._reports,Y,"delta_jitter_ms_out",!1,t),min:ct(this._reports,Y,"delta_jitter_ms_out",t),max:ut(this._reports,Y,"delta_jitter_ms_out",t),volatility:nt(this._reports,Y,"delta_jitter_ms_out",t),values:dt(this._reports,Y,"delta_jitter_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},a={avg:lt(this._reports,Y,"delta_kbs_out",!1,t),min:ct(this._reports,Y,"delta_kbs_out",t),max:ut(this._reports,Y,"delta_kbs_out",t),volatility:nt(this._reports,Y,"delta_kbs_out",t),values:dt(this._reports,Y,"delta_kbs_out",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},s={avg:lt(this._reports,Y,"delta_KBytes_out",!1,t),min:ct(this._reports,Y,"delta_KBytes_out",t),max:ut(this._reports,Y,"delta_KBytes_out",t),volatility:nt(this._reports,Y,"delta_KBytes_out",t),values:dt(this._reports,Y,"delta_KBytes_out",t),_unit:{avg:"KB",min:"KB",max:"KB",volatility:"percent"}},o={avg:vt(this._reports,Y,t),min:ct(this._reports,Y,"delta_rtt_ms_out",t),max:ut(this._reports,Y,"delta_rtt_ms_out",t),volatility:nt(this._reports,Y,"delta_rtt_ms_out",t),values:dt(this._reports,Y,"delta_rtt_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},r=pt(this._reports,Y,"total_packets_lost_out",t),n=pt(this._reports,Y,"total_packets_out",t),l={lost:r,avg:Math.round(100*(r/(r+n)*100||0))/100,values:dt(this._reports,Y,"delta_packets_lost_out",t),_unit:{avg:"percent",lost:"number"}};i[t].jitter=e,i[t].rtt=o,i[t].traffic=s,i[t].bitrate=a,i[t].loss=l,i[t].limitations=((t,e,a)=>{const s={other:0,cpu:0,bandwidth:0,none:100};if(!t||0===t.length)return s;const i=t[t.length-1].video[a];if(!i)return s;if(!("limitation_out"in i)||!("durations"in i.limitation_out))return s;if(!i.limitation_out.durations)return s;const{other:o,bandwidth:r,cpu:n,none:l}=i.limitation_out.durations,_=Number(o)+Number(r)+Number(n)+Number(l);return{other:+(o/_*100).toFixed(2),cpu:+(n/_*100).toFixed(2),bandwidth:+(r/_*100).toFixed(2),none:+(l/_*100).toFixed(2)}})(this._reports,0,t)}}))),{version:"2.0",configuration:{frequency:this._cfg.refreshEvery},started:this._start,ended:this._end,ua:{agent:navigator.userAgent,pname:this._cfg.pname,user_id:this._cfg.uid},call:{call_id:this._cfg.cid,events:this._events},details:{count:this._reports.length,reports:this._cfg.record?this._reports:[],reference:this._referenceReport||null},ssrc:i,data:{rtt:{avg:ft(this._reports,"data"),min:ct(this._reports,V,"delta_rtt_connectivity_ms"),max:ut(this._reports,V,"delta_rtt_connectivity_ms"),volatility:nt(this._reports,V,"delta_rtt_connectivity_ms"),values:dt(this._reports,V,"delta_rtt_connectivity_ms"),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},packetsLost:{audio:{in:{avg:Math.round(100*(t/(t+e)*100||0))/100}},video:{in:{avg:Math.round(100*(a/(a+s)*100||0))/100}},unit:{avg:"percent"}},bitrate:{in:{avg:lt(this._reports,"data","delta_kbs_in"),min:ct(this._reports,"data","delta_kbs_in"),max:ut(this._reports,"data","delta_kbs_in"),volatility:nt(this._reports,"data","delta_kbs_in"),values:dt(this._reports,V,"delta_kbs_in")},out:{avg:lt(this._reports,"data","delta_kbs_out"),min:ct(this._reports,"data","delta_kbs_out"),max:ut(this._reports,"data","delta_kbs_out"),volatility:nt(this._reports,"data","delta_kbs_out"),values:dt(this._reports,V,"delta_kbs_out")},unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},traffic:{in:{avg:lt(this._reports,"data","delta_KBytes_in"),min:ct(this._reports,"data","delta_KBytes_in"),max:ut(this._reports,"data","delta_KBytes_in"),volatility:nt(this._reports,"data","delta_KBytes_in"),values:dt(this._reports,V,"delta_KBytes_in")},out:{avg:lt(this._reports,"data","delta_KBytes_out"),min:ct(this._reports,"data","delta_KBytes_out"),max:ut(this._reports,"data","delta_KBytes_out"),volatility:nt(this._reports,"data","delta_KBytes_out"),values:dt(this._reports,V,"delta_KBytes_out")},unit:{avg:"KBytes",min:"KBytes",max:"KBytes",volatility:"percent"}},network:{localConnection:(n=this._reports,"relay"!==pt(n,"network","local_candidate_type")?`direct/${pt(n,"network","local_candidate_protocol")}`:`turn/${pt(n,"network","local_candidate_relay_protocol")}`),remoteConnection:gt(this._reports)}}};var n}updateConfig(t){this._cfg=t}getLastReport(){return this._reports.slice().pop()||null}getBeforeLastReport(){const t=this._reports.slice();return t.pop(),t.pop()||null}getReportsNumber(){return this._reports.length}}const kt=(t,e,a,s)=>{let i=!1;const o=s[e].total_rtt_ms_out,r=s[e].total_rtt_measure_out,n=a?a[e].total_rtt_ms_out:0,l=a?a[e].total_rtt_measure_out:0,_={rtt:null,totalRTT:o,totalRTTMeasurements:r};if(t.timestamp===s[e].timestamp_out)return _;if(!Object.prototype.hasOwnProperty.call(t,F))return _;if(Object.prototype.hasOwnProperty.call(t,W)&&(i=!0,0===Number(t.roundTripTimeMeasurements)||Number(t.roundTripTimeMeasurements)-l===r))return _;const c=Number(1e3)*Number(t.roundTripTime);let u=o+c,d=r+1;return i&&(u=Number(1e3)*Number(t.totalRoundTripTime)-n,d=Number(t.roundTripTimeMeasurements)-l),{rtt:c,totalRTT:u,totalRTTMeasurements:d}},wt=(t,e,a)=>t.timestamp===a[e].timestamp_out?null:Object.prototype.hasOwnProperty.call(t,E)?Number(1e3)*(Number(t.jitter)||0):null,Ct=(t,e,a)=>{const s=1e3*t.jitterBufferDelay||0,i=t.jitterBufferEmittedCount||0,o=s-a[e].total_time_jitter_buffer_delay_in,r=i-a[e].total_jitter_emitted_in;return{delta_ms_jitter_buffer_delay:r?o/r:0,total_time_jitter_buffer_delay:s,total_time_jitter_emitted:i}},xt=(t,e,a,s)=>{const i=Number(t.packetsSent)||0-(s?s[e].total_packets_out:0),o=i-a[e].total_packets_out,r=1e3*Number(t.totalPacketSendDelay)||0-(s?s[e].total_time_packets_delay_out:0),n=r-a[e].total_time_packets_delay_out,l=o?n/o:0,_=Number(t.bytesSent)/1024-(s?s[e].total_KBytes_out:0),c=_-a[e].total_KBytes_out,u=t.timestamp||Date.now(),d=s?s.timestamp:null;let p=a.timestamp;!p&&d&&(p=d);const h=p?u-p:0;return{packetsSent:i,deltaPacketsSent:o,KBytesSent:_,deltaKBytesSent:c,kbsSent:h>0?.008*c*1024/h*1e3:0,deltaAvgPacketSendDelay:l,totalPacketSendDelay:r}},St=(t,e,a,s)=>{let i=a[e].total_packets_lost_out,o=0,r=0;return Object.prototype.hasOwnProperty.call(t,$)&&(i=Number(t.packetsLost)||0-(s?s[e].total_packets_lost_out:0),o=i-a[e].total_packets_lost_out),Object.prototype.hasOwnProperty.call(t,S)&&(r=Number(100*t.fractionLost)),{packetsLost:i,deltaPacketsLost:o,fractionLost:r}},Rt=(t,e,a,s)=>{if(!Object.prototype.hasOwnProperty.call(t,D)||!Object.prototype.hasOwnProperty.call(t,$)||!Object.prototype.hasOwnProperty.call(t,C))return{percent_packets_lost:a[e].percent_packets_lost_in,packetsReceived:a[e].total_packets_in,packetsLost:a[e].total_packets_lost_in,bytesReceived:a[e].total_KBytes_in};const i=Number(t.packetsReceived)||0-(s?s[e].total_packets_in:0),o=Number(t.packetsLost)||0-(s?s[e].total_packets_lost_in:0),r=o-a[e].total_packets_lost_in,n=i-a[e].total_packets_in,l=i!==a[e].total_packets_in?100*r/(r+n):0,_=Number(t.bytesReceived)/1024-(s?s[e].total_KBytes_in:0),c=_-a[e].total_KBytes_in,u=t.timestamp||Date.now(),d=s?s.timestamp:null;let p=a.timestamp;!p&&d&&(p=d);const h=p?u-p:0;return{percentPacketsLost:l,packetsReceived:i,deltaPacketsReceived:n,packetsLost:o,deltaPacketsLost:r,KBytesReceived:_,deltaKBytesReceived:c,kbsReceived:h>0?.008*c*1024/h*1e3:0}},jt=t=>"relay"!==t.candidateType?"":t.relayProtocol||"",Bt=t=>{if(!Object.prototype.hasOwnProperty.call(t,I))return 3;switch(t.networkType){case"ethernet":return 0;case"cellular":return 5;case"wifi":return 3;default:return 10}},Lt=t=>Object.prototype.hasOwnProperty.call(t,R)&&Object.prototype.hasOwnProperty.call(t,j)?{width:t.frameWidth||0,height:t.frameHeight||0,framerate:t.framesPerSecond}:{width:0,height:0,framerate:0},Ot=(t,e)=>e||t<0?1:t>100?4.5:1+.035*t+7e-6*t*(t-60)*(100-t),Tt=(t,e,a,s,i)=>({currentSSRCReport:ht(t,e,i),previousSSRCReport:ht(t,a,i),beforeLastSSRCReport:ht(t,s,i)}),Nt=(t,e,a,s,i,o)=>{const r=[],n=i===p?t[s].delta_jitter_ms_in:t[s].delta_jitter_ms_out;if(r.push(n,n,n,n),o>1){const t=i===p?e&&e[s].delta_jitter_ms_in||null:e&&e[s].delta_jitter_ms_out||null;r.push(t,t)}return o>2&&r.push(i===p?a&&a[s].delta_jitter_ms_in||null:a&&a[s].delta_jitter_ms_out||null),it(r,10)},Kt=(t,e,a,s,i,o,r,n,l)=>{const _=[],c=n===p?e[r].delta_rtt_ms_in||t.data.delta_rtt_connectivity_ms:e[r].delta_rtt_ms_out||t.data.delta_rtt_connectivity_ms;if(_.push(c,c,c,c),l>1){const t=s&&(s[r].delta_rtt_ms_in||a.data.delta_rtt_connectivity_ms)||null;_.push(t,t)}return l>2&&_.push(n===p?o&&(o[r].delta_rtt_ms_in||i.data.delta_rtt_connectivity_ms)||null:o&&(o[r].delta_jitter_ms_out||i.data.delta_rtt_connectivity_ms)||null),it(_,100)},Et=(t,e,a,s,i,o)=>{const r=[],n=i===p?t[s].percent_packets_lost_in:t[s].percent_packets_lost_out;if(r.push(n,n,n,n),o>1){const t=i===p?e&&e[s].percent_packets_lost_in||null:e&&e[s].percent_packets_lost_out||null;r.push(t,t)}return o>2&&r.push(i===p?a&&a[s].percent_packets_lost_in||null:a&&a[s].percent_packets_lost_out||null),it(r,0)},Pt=(t,e,a,s=!1)=>a?s?t.type in a&&e in a[t.type]?a[t.type][e]:null:t.type in a&&t.ssrc in a[t.type]&&e in a[t.type][t.ssrc]?a[t.type][t.ssrc][e]:null:null,It=(t,e)=>e.find((e=>t in e.value?e.value[t]:null));class $t{constructor(t,e){this._callbacks={onreport:null,onticket:null},this._id=`coltr-${at()}`,this._moduleName=this._id,this._probeId=e,this._config=t,this._exporter=new bt(t),this._state=m,this.deviceChanged=()=>this._onDeviceChange(),this.connectionStateChange=()=>this._onConnectionStateChange(),this.iceConnectionStateChange=()=>this._onIceConnectionStateChange(),this.iceGatheringStateChange=()=>this._onIceGatheringStateChange(),this.track=t=>this._onTrack(t),this.negotiationNeeded=()=>this._onNegotiationNeeded(),n(this._moduleName,`new collector created for probe ${this._probeId}`)}analyze(t,e,a,s,i,r){const n=(t=>{const e={pname:"",call_id:"",user_id:"",timestamp:null,count:0,audio:{},video:{},network:{infrastructure:3,selected_candidate_pair_id:"",local_candidate_id:"",local_candidate_type:"",local_candidate_protocol:"",local_candidate_relay_protocol:"",remote_candidate_id:"",remote_candidate_type:"",remote_candidate_protocol:""},data:{total_KBytes_in:0,total_KBytes_out:0,delta_KBytes_in:0,delta_KBytes_out:0,delta_kbs_in:0,delta_kbs_out:0,delta_kbs_bandwidth_in:0,delta_kbs_bandwidth_out:0,delta_rtt_connectivity_ms:null,total_rtt_connectivity_ms:0,total_rtt_connectivity_measure:0},experimental:{time_to_measure_ms:0},passthrough:{}};if(t){const e={...t,audio:{},video:{},data:{...t.data},network:{...t.network},experimental:{...t.experimental},passthrough:{}};return Object.keys(t.audio).forEach((a=>{e.audio[a]={...t.audio[a]}})),Object.keys(t.video).forEach((a=>{e.video[a]={...t.video[a]}})),e}return{...e,audio:{},video:{},data:{...e.data},network:{...e.network},experimental:{...e.experimental}}})(a);let l=null;return t.forEach((s=>{!l&&s.timestamp&&(l=s.timestamp);const _=((t,e,a,s,i,r,n)=>{if(!t)return[];switch(o("extractor   ",`analyze() - got stats ${t.type} for ${a}`,t),t.type){case"candidate-pair":let a=!1,o=!1;if(i.has(t.transportId)&&i.get(t.transportId).selectedCandidatePairId===t.id&&(o=!0),U in t&&t.selected&&(a=!0),o||a){const i=t.localCandidateId,o=t.remoteCandidateId,r=t.id,n=((t,e,a)=>{const s=(t.bytesReceived||0)/1024-(a?a.data.total_KBytes_in:0),i=(t.bytesSent||0)/1024-(a?a.data.total_KBytes_out:0),o=t.timestamp||Date.now(),r=s-e.data.total_KBytes_in,n=i-e.data.total_KBytes_out,l=a?a.timestamp:null;let _=e.timestamp;!_&&l&&(_=l);const c=_?o-_:0;return{total_KBytes_received:s,total_KBytes_sent:i,delta_KBytes_received:r,delta_KBytes_sent:n,kbs_speed_received:c>0?.008*r*1024/c*1e3:0,kbs_speed_sent:c>0?.008*n*1024/c*1e3:0}})(t,e,s),l=(t=>({kbs_incoming_bandwidth:t.availableIncomingBitrate/1024||0,kbs_outgoing_bandwidth:t.availableOutgoingBitrate/1024||0}))(t),_=((t,e,a,s)=>{if(!Object.prototype.hasOwnProperty.call(t,x))return{rtt:null,totalRTT:s.data.total_rtt_connectivity_ms,totalRTTMeasurements:s.data.total_rtt_connectivity_measure};const i=Number(1e3)*Number(t.currentRoundTripTime);let o=s.data.total_rtt_connectivity_ms+i,r=s.data.total_rtt_connectivity_measure+1;return Object.prototype.hasOwnProperty.call(t,G)&&(o=Number(1e3)*Number(t.totalRoundTripTime)-(a?a.data.total_rtt_connectivity_ms:0)),Object.prototype.hasOwnProperty.call(t,A)&&(r=Number(t.responsesReceived)-(a?a.data.total_rtt_connectivity_measure:0)),{rtt:i,totalRTT:o,totalRTTMeasurements:r}})(t,0,s,e),c=[{type:Z,value:{local_candidate_id:i}},{type:Z,value:{remote_candidate_id:o}},{type:tt,value:{total_KBytes_in:n.total_KBytes_received}},{type:tt,value:{total_KBytes_out:n.total_KBytes_sent}},{type:tt,value:{delta_KBytes_in:n.delta_KBytes_received}},{type:tt,value:{delta_KBytes_out:n.delta_KBytes_sent}},{type:tt,value:{delta_kbs_in:n.kbs_speed_received}},{type:tt,value:{delta_kbs_out:n.kbs_speed_sent}},{type:tt,value:{delta_kbs_bandwidth_in:l.kbs_incoming_bandwidth}},{type:tt,value:{delta_kbs_bandwidth_out:l.kbs_outgoing_bandwidth}},{type:tt,value:{delta_rtt_connectivity_ms:_.rtt}},{type:tt,value:{total_rtt_connectivity_ms:_.totalRTT}},{type:tt,value:{total_rtt_connectivity_measure:_.totalRTTMeasurements}}];return a&&c.push({type:Z,internal:"selectedPairChanged",value:{selected_candidate_pair_id:r}}),c}break;case"local-candidate":if(t.id===e.network.local_candidate_id)return[{type:Z,value:{infrastructure:Bt(t)}},{type:Z,value:{local_candidate_type:t.candidateType||""}},{type:Z,value:{local_candidate_protocol:t.protocol||""}},{type:Z,value:{local_candidate_relay_protocol:jt(t)}}];break;case"remote-candidate":if(t.id===e.network.remote_candidate_id)return[{type:Z,value:{remote_candidate_type:t.candidateType||""}},{type:Z,value:{remote_candidate_protocol:t.protocol||""}}];break;case w:{const a=t.ssrc,o=ht(a,e,p);o&&(o.timestamp=e.timestamp);const n=ht(a,s,p);if(n&&(n.timestamp=s.timestamp),t.mediaType===H){const e=Rt(t,H,o,n),s=wt(t,H,o),l=t.codecId||"",_=t.audioLevel||0;let c=null;i.has(t.playoutId)&&(c=((t,e)=>{const a=e&&1e3*e.synthesizedSamplesDuration||0,s=t&&1e3*t.synthesizedSamplesDuration||0,i=t&&1e3*t.totalSamplesDuration||0,o=s-a,r=i-(e&&1e3*e.totalSamplesDuration||0),n=t&&t.totalPlayoutDelay||0,l=t&&t.totalSamplesCount||0;return{total_synthetized_ms_in:s,delta_synthetized_ms_in:o,percent_synthetized_in:r?o/r*100:0,total_percent_synthetized_in:i?s/i*100:0,total_playout_ms_in:n,delta_playout_delay_ms_in:l?n/l:0}})(i.get(t.playoutId),r?r.get(t.playoutId):null));const u=Ct(t,H,o);return[{ssrc:a,type:Q,value:{codec_id_in:l}},{ssrc:a,type:Q,value:{total_packets_in:e.packetsReceived}},{ssrc:a,type:Q,value:{delta_packets_in:e.deltaPacketsReceived}},{ssrc:a,type:Q,value:{total_packets_lost_in:e.packetsLost}},{ssrc:a,type:Q,value:{delta_packets_lost_in:e.deltaPacketsLost}},{ssrc:a,type:Q,value:{percent_packets_lost_in:e.percentPacketsLost}},{ssrc:a,type:Q,value:{total_KBytes_in:e.KBytesReceived}},{ssrc:a,type:Q,internal:"bytesReceivedChanged",value:{delta_KBytes_in:e.deltaKBytesReceived}},{ssrc:a,type:Q,value:{delta_kbs_in:e.kbsReceived}},{ssrc:a,type:Q,value:{delta_jitter_ms_in:s}},{ssrc:a,type:Q,value:{delta_jitter_buffer_delay_ms_in:u.delta_ms_jitter_buffer_delay}},{ssrc:a,type:Q,value:{total_time_jitter_buffer_delay_in:u.total_time_jitter_buffer_delay}},{ssrc:a,type:Q,value:{total_jitter_emitted_in:u.total_time_jitter_emitted}},{ssrc:a,type:Q,value:{track_in:t.trackIdentifier}},{ssrc:a,type:Q,internal:"ssrcIdentifierIn",value:{ssrc_in:t.ssrc}},{ssrc:a,type:Q,value:{level_in:_}},{ssrc:a,type:Q,value:{delta_synthetized_ms_in:c?c.delta_synthetized_ms_in:0}},{ssrc:a,type:Q,value:{total_synthetized_ms_in:c?c.total_synthetized_ms_in:0}},{ssrc:a,type:Q,value:{delta_playout_delay_ms_in:c?c.delta_playout_delay_ms_in:0}},{ssrc:a,type:Q,value:{total_playout_ms_in:c?c.total_playout_ms_in:0}},{ssrc:a,type:Q,value:{percent_synthetized_in:c?c.percent_synthetized_in:0}},{ssrc:a,type:Q,value:{total_percent_synthetized_in:c?c.total_percent_synthetized_in:0}}]}if(t.mediaType===Y){const e=((t,e)=>{if(!Object.prototype.hasOwnProperty.call(t,B)||!Object.prototype.hasOwnProperty.call(t,J))return{delta_ms_decode_frame:e.video.delta_decode_frame_ms_in,frames_decoded:e.video.total_frames_decoded_in,total_decode_time:e.video.total_time_decoded_in};const a=t.framesDecoded,s=1e3*t.totalDecodeTime,i=1e3*t.totalProcessingDelay||0,o=1e3*t.totalAssemblyTime||0,r=i-e.video.total_time_processing_delay_in,n=s-e.video.total_time_decoded_in,l=a-e.video.total_frames_decoded_in,_=o-e.video.total_time_assembly_delay_in;return{frames_decoded:a,delta_ms_decode_frame:l>0?n/l:0,delta_ms_processing_delay:l>0?r/l:0,delta_ms_assembly_delay:l>0?_/l:0,total_time_processing_delay:i,total_decode_time:s,total_assembly_time:o}})(t,o),s=Rt(t,Y,o,n),i=wt(t,Y,o),r=t.decoderImplementation||null,l=t.codecId||null,_=Lt(t),c=((t,e,a)=>{if(!Object.prototype.hasOwnProperty.call(t,M)||!Object.prototype.hasOwnProperty.call(t,P))return{pliCount:e.total_pli_sent_in,nackCount:e.total_nack_sent_in,deltaPliCount:0,deltaNackCount:0};const s=(t.pliCount||0)-(a?a.video.total_pli_sent_in:0),i=(t.nackCount||0)-(a?a.video.total_nack_sent_in:0);return{pliCount:s,nackCount:i,deltaPliCount:s-e.video.total_pli_sent_in,deltaNackCount:i-e.video.total_nack_sent_in}})(t,o,n),u=((t,e,a,s)=>{if(!Object.prototype.hasOwnProperty.call(t,O)||!Object.prototype.hasOwnProperty.call(t,z))return{freezeCount:a.video.total_glitch_in.freeze,pauseCount:a.video.total_glitch_in.pause,deltaFreezeCount:0,deltaPauseCount:0};const i=(t.freezeCount||0)-(s?s.video.total_glitch_in.freeze:0),o=(t.pauseCount||0)-(s?s.video.total_glitch_in.pause:0);return{freezeCount:i,pauseCount:o,deltaFreezeCount:i-a.video.total_glitch_in.freeze,deltaPauseCount:o-a.video.total_glitch_in.pause}})(t,0,o,n),d=Ct(t,H,o);return[{ssrc:a,type:X,value:{codec_id_in:l}},{ssrc:a,type:X,value:{total_packets_in:s.packetsReceived}},{ssrc:a,type:X,value:{delta_packets_in:s.deltaPacketsReceived}},{ssrc:a,type:X,value:{total_packets_lost_in:s.packetsLost}},{ssrc:a,type:X,value:{delta_packets_lost_in:s.deltaPacketsLost}},{ssrc:a,type:X,value:{percent_packets_lost_in:s.percentPacketsLost}},{ssrc:a,type:X,value:{total_KBytes_in:s.KBytesReceived}},{ssrc:a,type:X,internal:"bytesReceivedChanged",value:{delta_KBytes_in:s.deltaKBytesReceived}},{ssrc:a,type:X,value:{delta_kbs_in:s.kbsReceived}},{ssrc:a,type:X,value:{delta_jitter_ms_in:i}},{ssrc:a,type:X,value:{delta_jitter_buffer_delay_ms_in:d.delta_ms_jitter_buffer_delay}},{ssrc:a,type:X,value:{total_time_jitter_buffer_delay_in:d.total_time_jitter_buffer_delay}},{ssrc:a,type:X,value:{total_jitter_emitted_in:d.total_time_jitter_emitted}},{ssrc:a,type:X,value:{decoder_in:r}},{ssrc:a,type:X,value:{delta_decode_frame_ms_in:e.delta_ms_decode_frame}},{ssrc:a,type:X,value:{total_frames_decoded_in:e.frames_decoded}},{ssrc:a,type:X,value:{delta_processing_delay_ms_in:e.delta_ms_processing_delay}},{ssrc:a,type:X,value:{total_time_processing_delay_in:e.total_time_processing_delay}},{ssrc:a,type:X,value:{delta_assembly_delay_ms_in:e.delta_ms_assembly_delay}},{ssrc:a,type:X,value:{total_time_assembly_delay_in:e.total_assembly_time}},{ssrc:a,type:X,value:{total_time_decoded_in:e.total_decode_time}},{ssrc:a,type:X,value:{total_nack_sent_in:c.nackCount}},{ssrc:a,type:X,value:{delta_nack_sent_in:c.deltaNackCount}},{ssrc:a,type:X,value:{total_pli_sent_in:c.pliCount}},{ssrc:a,type:X,value:{delta_pli_sent_in:c.deltaPliCount}},{ssrc:a,type:X,value:{size_in:_},internal:"inputSizeChanged"},{ssrc:a,type:X,value:{track_in:t.trackIdentifier}},{ssrc:a,type:X,internal:"ssrcIdentifierIn",value:{ssrc_in:t.ssrc}},{ssrc:a,type:X,value:{total_glitch_in:{freeze:u.freezeCount,pause:u.pauseCount},delta_glitch_in:{freeze:u.deltaFreezeCount,pause:u.deltaPauseCount}},internal:"glitchChanged"}]}break}case"outbound-rtp":{const a=!!t.mediaSourceId,o=t.ssrc,r=ht(o,e,h);r&&(r.timestamp=e.timestamp);const l=ht(o,s,h);l&&(l.timestamp=s.timestamp);let _="",c=0,u={width:0,height:0,framerate:0};if(a&&i.has(t.mediaSourceId)){const e=i.get(t.mediaSourceId);_=e.trackIdentifier,t.kind===H?c=e.audioLevel:u={width:e.width||null,height:e.height||null,framerate:e.framesPerSecond||null}}let d="";if(_){const t=((t,e)=>{const a=e.getSenders().find((e=>e.track&&e.track.id===t));if(a)return a.track;const s=e.getReceivers().find((e=>e.track&&e.track.id===t));return s?s.track:null})(_,n);t&&(d=t.label)}if(t.mediaType===H){const e=t.codecId||null;if(!_){const t=mt("audio",n);t&&(_=t.id,d=t.label)}const s=xt(t,H,r,l);return[{ssrc:o,type:Q,internal:"mediaSourceUpdated",value:{active_out:a}},{ssrc:o,type:Q,value:{device_out:d}},{ssrc:o,type:Q,value:{codec_id_out:e}},{ssrc:o,type:Q,value:{total_packets_out:s.packetsSent}},{ssrc:o,type:Q,value:{delta_packets_out:s.deltaPacketsSent}},{ssrc:o,type:Q,value:{delta_packet_delay_ms_out:s.deltaAvgPacketSendDelay}},{ssrc:o,type:Q,value:{total_time_packets_delay_out:s.totalPacketSendDelay}},{ssrc:o,type:Q,value:{total_KBytes_out:s.KBytesSent}},{ssrc:o,type:Q,internal:"bytesSentChanged",value:{delta_KBytes_out:s.deltaKBytesSent}},{ssrc:o,type:Q,value:{delta_kbs_out:s.kbsSent}},{ssrc:o,type:Q,internal:"deviceChanged",value:{track_out:_}},{ssrc:o,type:Q,value:{level_out:c}},{ssrc:o,type:Q,internal:"ssrcIdentifierOut",value:{ssrc_out:t.ssrc}}]}if(t.mediaType===Y){const e=t.encoderImplementation||null,s=t.codecId||null;if(!_){const t=mt("video",n);t&&(_=t.id,d=t.label)}const i=((t,e)=>{if(!Object.prototype.hasOwnProperty.call(t,L)||!Object.prototype.hasOwnProperty.call(t,q))return{delta_ms_encode_frame:e.video.delta_encode_frame_ms_out,frames_encoded:e.video.total_frames_encoded_out,total_encode_time:e.video.total_time_encoded_out};const a=t.framesEncoded,s=t.totalEncodeTime,i=s-e.video.total_time_encoded_out,o=a-e.video.total_frames_encoded_out;return{delta_ms_encode_frame:o>0&&i?1e3*i/o:0,frames_encoded:a,total_encode_time:s}})(t,r),c=Lt(t),p=(t=>{const e=Object.prototype.hasOwnProperty.call(t,T)?t.qualityLimitationReason:null,a=Object.prototype.hasOwnProperty.call(t,K)?t.qualityLimitationResolutionChanges:null,s=Object.prototype.hasOwnProperty.call(t,N)?t.qualityLimitationDurations:null;return s&&Object.keys(s).forEach((t=>{s[t]>1e3&&(s[t]=Number(s[t]/1e3))})),{reason:e,durations:s,resolutionChanges:a}})(t),h=((t,e,a)=>{if(!Object.prototype.hasOwnProperty.call(t,M)||!Object.prototype.hasOwnProperty.call(t,P))return{pliCount:e.total_pli_received_out,nackCount:e.total_nack_received_out,deltaPliCount:0,deltaNackCount:0};const s=(t.pliCount||0)-(a?a.video.total_pli_received_out:0),i=(t.nackCount||0)-(a?a.video.total_nack_received_out:0);return{pliCount:s,nackCount:i,deltaPliCount:s-e.video.total_pli_received_out,deltaNackCount:i-e.video.total_nack_received_out}})(t,r,l),m=xt(t,Y,r,l);return[{ssrc:o,type:X,internal:"mediaSourceUpdated",value:{active_out:a}},{ssrc:o,type:X,value:{device_out:d}},{ssrc:o,type:X,value:{codec_id_out:s}},{ssrc:o,type:X,value:{total_packets_out:m.packetsSent}},{ssrc:o,type:X,value:{delta_packets_out:m.deltaPacketsSent}},{ssrc:o,type:X,value:{delta_packet_delay_ms_out:m.deltaAvgPacketSendDelay}},{ssrc:o,type:X,value:{total_time_packets_delay_out:m.totalPacketSendDelay}},{ssrc:o,type:X,value:{total_KBytes_out:m.KBytesSent}},{ssrc:o,type:X,internal:"bytesSentChanged",value:{delta_KBytes_out:m.deltaKBytesSent}},{ssrc:o,type:X,value:{delta_kbs_out:m.kbsSent}},{ssrc:o,type:X,value:{encoder_out:e}},{ssrc:o,type:X,value:{delta_encode_frame_ms_out:i.delta_ms_encode_frame}},{ssrc:o,type:X,value:{total_frames_encoded_out:i.frames_encoded}},{ssrc:o,type:X,value:{total_time_encoded_out:i.total_encode_time}},{ssrc:o,type:X,value:{total_nack_received_out:h.nackCount}},{ssrc:o,type:X,value:{delta_nack_received_out:h.deltaNackCount}},{ssrc:o,type:X,value:{total_pli_received_out:h.pliCount}},{ssrc:o,type:X,value:{delta_pli_received_out:h.deltaPliCount}},{ssrc:o,type:X,value:{size_out:c},internal:"outputSizeChanged"},{ssrc:o,type:X,value:{limitation_out:p},internal:"videoLimitationChanged"},{ssrc:o,type:X,internal:"deviceChanged",value:{track_out:_}},{ssrc:o,type:X,value:{size_pref_out:u}},{ssrc:o,type:X,internal:"ssrcIdentifierOut",value:{ssrc_out:t.ssrc}}]}break}default:break;case"codec":const l=[];return Object.keys(e.audio).forEach((a=>{const s=e.audio[a];if(s.codec_id_in===t.id||s.codec_id_out===t.id){const e=(t=>({channels:t.channels||null,clock_rate:t.clockRate||null,mime_type:t.mimeType||null,sdp_fmtp_line:t.sdpFmtpLine||null}))(t);t.id===s.codec_id_in?l.push({ssrc:s.ssrc,type:Q,value:{codec_in:e}}):l.push({ssrc:s.ssrc,type:Q,value:{codec_out:e}})}})),Object.keys(e.video).forEach((a=>{const s=e.video[a];if(s.codec_id_in===t.id||s.codec_id_out===t.id){const e=(t=>({clock_rate:t.clockRate||null,mime_type:t.mimeType||null}))(t);t.id===s.codec_id_in?l.push({ssrc:s.ssrc,type:X,value:{codec_in:e}}):l.push({ssrc:s.ssrc,type:X,value:{codec_out:e}})}})),l;case"remote-inbound-rtp":{const a=t.ssrc,i=ht(a,e,h),o=ht(a,s,h);if(t.kind===H){const e=kt(t,H,o,i),s=wt(t,H,i),r=St(t,H,i,o);return[{ssrc:a,type:Q,value:{delta_rtt_ms_out:e.rtt}},{ssrc:a,type:Q,value:{total_rtt_ms_out:e.totalRTT}},{ssrc:a,type:Q,value:{total_rtt_measure_out:e.totalRTTMeasurements}},{ssrc:a,type:Q,value:{delta_jitter_ms_out:s}},{ssrc:a,type:Q,value:{timestamp_out:t.timestamp}},{ssrc:a,type:Q,value:{total_packets_lost_out:r.packetsLost}},{ssrc:a,type:Q,value:{delta_packets_lost_out:r.deltaPacketsLost}},{ssrc:a,type:Q,value:{percent_packets_lost_out:r.fractionLost}}]}if(t.kind===Y){const e=kt(t,Y,o,i),s=wt(t,Y,i),r=St(t,Y,i,o);return[{ssrc:a,type:X,value:{delta_rtt_ms_out:e.rtt}},{ssrc:a,type:X,value:{total_rtt_ms_out:e.totalRTT}},{ssrc:a,type:X,value:{total_rtt_measure_out:e.totalRTTMeasurements}},{ssrc:a,type:X,value:{delta_jitter_ms_out:s}},{ssrc:a,type:X,value:{timestamp_out:t.timestamp}},{ssrc:a,type:X,value:{total_packets_lost_out:r.packetsLost}},{ssrc:a,type:X,value:{delta_packets_lost_out:r.deltaPacketsLost}},{ssrc:a,type:X,value:{percent_packets_lost_out:r.fractionLost}}]}break}case"remote-outbound-rtp":{const a=t.ssrc,i=ht(a,e,h),o=ht(a,s,h);if(t.kind===H){const e=kt(t,H,o,i);return[{ssrc:a,type:Q,value:{delta_rtt_ms_in:e.rtt}},{ssrc:a,type:Q,value:{total_rtt_ms_in:e.totalRTT}},{ssrc:a,type:Q,value:{total_rtt_measure_in:e.totalRTTMeasurements}},{ssrc:a,type:Q,value:{timestamp_in:t.timestamp}}]}break}case"transport":{const e=t.selectedCandidatePairId;return[{type:Z,internal:"selectedPairChanged",value:{selected_candidate_pair_id:e}}]}}return[]})(s,n,n.pname,i,t,e,r);_.forEach((t=>{if("internal"in t&&((t,e,a)=>{const s=[],i=(t,e,a,i,o)=>{s.push({at:t,ended:null,category:e,name:a,ssrc:i,details:o})},o=s=>{const o=t.value[s],r=Pt(t,s,e);var n,l;(!s.includes("out")||It("active_out",a))&&(r?.width!==o.width&&i((new Date).toJSON(),"quality",!r||r.width<o.width?"size-up":"size-down",t.ssrc,{message:`The resolution of the ${s.includes("out")?"outbound":"inbound"} ${t.type} stream has ${!r||r.width<o.width?"increased":"decreased"} to ${o.width}x${o.height}`,direction:s.includes("out")?"outbound":"inbound",kind:t.type,value:`${o.width}x${o.height}`,value_old:`${r?r.width:0}x${r?r.height:0}`}),n=r?.framerate,l=o?.framerate,n&&Math.abs(n-l)>2&&i((new Date).toJSON(),"quality",!r||r.framerate<o.framerate?"fps-up":"fps-down",t.ssrc,{message:`The framerate of the ${s.includes("out")?"outbound":"inbound"} ${t.type} stream has ${!r||r.framerate<o.framerate?"increased":"decreased"} to ${o.framerate}`,direction:s.includes("out")?"outbound":"inbound",kind:t.type,value:o.framerate,value_old:r?r.framerate:0}))},r=s=>{const o=t.value[s],r=Pt(t,s,e);var n,l;(!s.includes("out")||It("active_out",a))&&(n=r,(l=o)&&Math.abs(n-l)/(100*l)>50&&i((new Date).toJSON(),"quality",o>r?"peak-up":"peak-down",t.ssrc,{message:`A peak has been detected for the ${s.includes("out")?"outbound":"inbound"} ${t.type} steam.`,direction:s.includes("out")?"outbound":"inbound",kind:t.type,value:o,value_old:r}))},n=a=>{const s=t.value[a],o=Pt(t,a,e);s&&!o&&i((new Date).toJSON(),"call","track-added",s,{message:`New track added to the call ${s}`,direction:a.includes("in")?"inbound":"outbound",kind:t.type,value:s,value_old:null})};switch(t.internal){case"deviceChanged":e&&(s=>{const o=t.value.track_out,r=Pt(t,s,e),n=It("device_out",a),l=Pt(t,"device_out",e);let _="track-stop";if(r!==o){let e=`The existing outbound ${t.type} stream from ${l||"unknown"} has been stopped or muted`;o&&r?(e=`The existing outbound ${t.type} device has been changed to ${n?n.value.device_out:"unknown"}`,_="track-change"):r||(e=`A new outbound ${t.type} stream from ${n?n.value.device_out:"unknown"} has been started or unmuted`,_="track-start"),i((new Date).toJSON(),"call",_,t.ssrc,{message:e,direction:"outbound",kind:t.type,value:o,value_old:r})}})("track_out");break;case"inputSizeChanged":o("size_in");break;case"outputSizeChanged":o("size_out");break;case"bytesSentChanged":r("delta_KBytes_out");break;case"bytesReceivedChanged":e&&r("delta_KBytes_in");break;case"mediaSourceUpdated":e&&(a=>{const s=t.value[a],o=Pt(t,a,e);s!==o&&i((new Date).toJSON(),"call",s?"track-active":"track-inactive",t.ssrc,{message:`The ${a.includes("out")?"outbound":"inbound"} ${t.type} stream switched to ${s?"active":"inactive"}`,direction:a.includes("out")?"outbound":"inbound",kind:t.type,value:s,value_old:o})})("active_out");break;case"videoLimitationChanged":(a=>{const s=t.value[a],o=Pt(t,a,e);o&&s.reason===o.reason||i((new Date).toJSON(),"quality","limitation",t.ssrc,{message:"The outbound video stream resolution is "+("none"===s.reason?"no more limited":`limited due to ${s.reason} reason`),direction:a.includes("out")?"outbound":"inbound",kind:t.type,value:s.reason,value_old:o})})("limitation_out");break;case"selectedPairChanged":(a=>{const s=t.value[a],o=Pt(t,a,e,!0);s!==o&&i((new Date).toJSON(),"signal","route-change",null,{message:`The selected candidates pair changed to ${s}`,direction:null,kind:null,value:s,value_old:o})})("selected_candidate_pair_id");break;case"ssrcIdentifierIn":n("ssrc_in");break;case"ssrcIdentifierOut":n("ssrc_out")}return s})(t,a,_).forEach((t=>this.addCustomEvent(t))),t.value&&t.type)if(t.ssrc){let a=n[t.type][t.ssrc];a||(e=t.type,i=s.type,a=e===H?i===w?{...v}:{...f}:i===w?{...g}:{...b},a.ssrc=t.ssrc,n[t.type][t.ssrc]=a),Object.keys(t.value).forEach((e=>{a[e]=t.value[e]}))}else Object.keys(t.value).forEach((e=>{n[t.type][e]=t.value[e]}));var e,i}));const c=((t,e)=>{if(!t)return[];const a=e&&e[t.type]||[],s={};if(a.length>0){const e=t.ssrc||t.id,i=t.kind||"",o=`${t.type}${i?`-${i}`:""}_${e}`;a.forEach((e=>{e in t&&(e in s||(s[e]={}),s[e][o]=t[e])}))}return s})(s,this._config.passthrough);Object.keys(c).forEach((t=>{n.passthrough[t]||(n.passthrough[t]={}),n.passthrough[t]={...n.passthrough[t],...c[t]}}))})),n.pname=this._config.pname,n.call_id=this._config.cid,n.user_id=this._config.uid,n.count=a?a.count+1:1,n.timestamp=l,Object.keys(n.audio).forEach((t=>{const e=n.audio[t];e[e.direction===p?"mos_emodel_in":"mos_model_out"]=((t,e,a,s,i,o="inbound",r=3)=>{const{currentSSRCReport:n,previousSSRCReport:l,beforeLastSSRCReport:_}=Tt(i,t,a,s,o),c=Et(n,l,_,e,o,r),u=Kt(t,n,a,l,s,_,e,o,r),d=Nt(n,l,_,e,o,r),p=Math.max(0,93.2-c),h=(u+d)/2;return Ot(.18*p*p-27.9*p+1126.62-(.024*h+.11*(h-177.3)*(h-177.3<0?0:1)),c>30)})(n,H,a,s,e.ssrc,e.direction,3),e[e.direction===p?"mos_in":"mos_out"]=((t,e,a,s,i,o="inbound",r=3)=>{const{currentSSRCReport:n,previousSSRCReport:l,beforeLastSSRCReport:_}=Tt(i,t,a,s,o),c=Et(n,l,_,e,o,r),u=(Kt(t,n,a,l,s,_,e,o,r)+Nt(n,l,_,e,o,r))/2+30,d=.024*u+.11*(u-177.3)*(u-177.3<0?0:1),p=0+19.8*Math.log(1+29.7*c);return Ot(93.2-(p+d))})(n,H,a,s,e.ssrc,e.direction,3),e[e.direction===p?"mos_fullband_in":"mos_fullband_out"]=((t,e,a,s,i,o="inbound",r=3)=>{let n=0;const{currentSSRCReport:l,previousSSRCReport:_,beforeLastSSRCReport:c}=Tt(i,t,a,s,o),u=Et(l,_,c,e,o,r),d=(Kt(t,l,a,_,s,c,e,o,r)+Nt(l,_,c,e,o,r))/2,p=10.2+u/(u+4.3)*121.8;if(d>100){const t=(Math.log(d)-Math.log(100))/Math.log(2);n=37*((1+t**6)**(1/6)-3*(1+(t/3)**6)**(1/6)+2)}return Ot((148-n-p+0)/1.48)})(n,H,a,s,e.ssrc,e.direction,3)})),n}async takeReferenceStats(){return new Promise(((t,e)=>{const a=Date.now();setTimeout((async()=>{try{const e=Date.now()-a,s=Date.now(),i=await this._config.pc.getStats(),r=this.analyze(i,null,null,null,null,this._config.pc),n=Date.now();r.experimental.time_to_measure_ms=n-s,r.experimental.time_to_wait_ms=e,this._exporter.saveReferenceReport(r),o(this._moduleName,`got reference report for probe ${this._probeId}`),t()}catch(t){e(t)}}),this._config.startAfter)}))}async collectStats(){try{if(this._state!==y||!this._config.pc)return o(this._moduleName,`report discarded (too late) for probe ${this._probeId}`),null;const t=Date.now(),e=await this._config.pc.getStats(),a=this.analyze(e,this._oldReports,this._exporter.getLastReport(),this._exporter.getBeforeLastReport(),this._exporter.getReferenceReport(),this._config.pc);this._oldReports=e;const s=Date.now();return a.experimental.time_to_measure_ms=s-t,this._exporter.addReport(a),o(this._moduleName,`got report for probe ${this._probeId}#${this._exporter.getReportsNumber()+1}`),this.fireOnReport(a),a}catch(t){return _(this._moduleName,`got error ${t}`),null}}async start(){o(this._moduleName,"starting"),this._oldReports=null,this._exporter.reset(),await this.registerToPCEvents(),this.state=y,this._exporter.start(),o(this._moduleName,"started")}async mute(){this.state="muted",o(this._moduleName,"muted")}async unmute(){this.state=y,o(this._moduleName,"unmuted")}async stop(t){if(o(this._moduleName,`stopping${t?" by watchdog":""}...`),this._exporter.stop(),this.unregisterToPCEvents(),this.state=m,this._config.ticket){const t=this._exporter.generateTicket();this.fireOnTicket(t)}o(this._moduleName,"stopped")}registerCallback(t,e,a){t in this._callbacks?(this._callbacks[t]={callback:e,context:a},o(this._moduleName,`registered callback '${t}'`)):_(this._moduleName,`can't register callback for '${t}' - not found`)}unregisterCallback(t){t in this._callbacks?(this._callbacks[t]=null,delete this._callbacks[t],o(this._moduleName,`unregistered callback '${t}'`)):_(this._moduleName,`can't unregister callback for '${t}' - not found`)}fireOnReport(t){this._callbacks.onreport&&rt(this._callbacks.onreport.callback,this._callbacks.onreport.context,t)}fireOnTicket(t){this._callbacks.onticket&&rt(this._callbacks.onticket.callback,this._callbacks.onticket.context,t)}updateConfig(t){this._config=t,this._exporter.updateConfig(t)}get state(){return this._state}set state(t){this._state=t,o(this._moduleName,`state changed to ${t}`)}addCustomEvent(t){this._exporter.addCustomEvent(t)}async _onDeviceChange(){try{const t=await navigator.mediaDevices.enumerateDevices();this.addCustomEvent({at:(new Date).toJSON(),ended:null,category:"device",name:"device-change",ssrc:null,details:{message:"One device (at least) has been plugged or unplugged",direction:null,kind:null,value:t.length,value_old:null}})}catch(t){_(this._moduleName,"can't get devices")}}_onIceConnectionStateChange(){const{pc:t}=this._config,e=t.iceConnectionState;this.addCustomEvent({at:(new Date).toJSON(),ended:null,category:"signal",name:"ice-change",ssrc:null,details:{message:`The ICE connection state has changed to ${e}`,direction:null,kind:null,value:e,value_old:null}})}_onConnectionStateChange(){const{pc:t}=this._config,e=t.connectionState;this.addCustomEvent({at:(new Date).toJSON(),ended:null,category:"signal",name:"connection-change",ssrc:null,details:{message:`The connection state has changed to ${e}`,direction:null,kind:null,value:e,value_old:null}})}_onIceGatheringStateChange(){const{pc:t}=this._config,e=t.iceGatheringState;this.addCustomEvent({at:(new Date).toJSON(),ended:null,category:"signal",name:"gathering-change",ssrc:null,details:{message:`The ICE gathering state has changed to ${e}`,direction:null,kind:null,value:e,value_old:null}})}_onTrack(t){this.addCustomEvent({at:(new Date).toJSON(),ended:null,category:"signal",name:"track-received",ssrc:null,details:{message:`A new inbound ${t.track.id} stream has been started`,direction:"inbound",kind:t.track.kind,value:t.track.label,value_old:null}})}_onNegotiationNeeded(){this.addCustomEvent({at:(new Date).toJSON(),ended:null,category:"signal",name:"ice-negotiation",ssrc:null,details:{message:"A negotiation is required",direction:null,kind:null,value:"negotiation-needed",value_old:null}})}async registerToPCEvents(){const{pc:t}=this._config;navigator.mediaDevices.addEventListener("devicechange",this.deviceChanged),t&&(t.addEventListener("iceconnectionstatechange",this.iceConnectionStateChange),t.addEventListener("connectionstatechange",this.connectionStateChange),t.addEventListener("icegatheringstatechange",this.iceGatheringStateChange),t.addEventListener("track",this.track),t.addEventListener("negotiationneeded",this.negotiationNeeded))}unregisterToPCEvents(){const{pc:t}=this._config;navigator.mediaDevices.removeEventListener("devicechange",this.deviceChanged),t&&(t.removeEventListener("iceconnectionstatechange",this.iceConnectionStateChange),t.removeEventListener("connectionstatechange",this.connectionStateChange),t.removeEventListener("icegatheringstatechange",this.iceGatheringStateChange),t.removeEventListener("track",this.track),t.removeEventListener("negotiationneeded",this.negotiationNeeded))}getTicket(){return this._exporter&&this._exporter.generateTicket()}}class Dt{constructor(t){this._id=t.pname&&t.pname.substr(0,12).padEnd(12," ")||`probe-${at()}`,this._moduleName=this._id,n(this._moduleName,"probe created"),this._config=t,this._collector=new $t(this._config,this._id)}set onreport(t){t?this._collector.registerCallback("onreport",t):this._collector.unregisterCallback("onreport")}set onticket(t){t?this._collector.registerCallback("onticket",t):this._collector.unregisterCallback("onticket")}get id(){return this._id}get pname(){return this._config.pname}get cid(){return this._config.cid}get uid(){return this._config.uid}get state(){return this._collector.state}set state(t){this._collector.state=t}addCustomEvent(t,e,a,s=new Date,i=null,o=null,r=null){let n=null;r&&(n="object"==typeof r?r.toJSON():r),this._collector.addCustomEvent({at:"object"==typeof s?s.toJSON():s,ended:n,category:e,name:t,ssrc:i,details:{message:a,kind:null,direction:null,value:o,value_old:null}})}get isRunning(){return this._collector.state===y}get isIdle(){return this._collector.state===m}updateUserId(t){this._config.uid=t,this._collector.updateConfig(this._config)}updateCallId(t){this._config.cid=t,this._collector.updateConfig(this._config)}start(){this.isIdle?this._collector.start():l(this._moduleName,"probe is already running")}stop(t=!1){this.isRunning&&this._collector.stop(t)}async takeReferenceStats(){return this._collector.takeReferenceStats()}async collectStats(){return this._collector.collectStats()}getTicket(){return this._collector&&this._collector.getTicket()}}const zt="engine      ";class Mt{constructor(t){this._config=t,this._probes=[],this._startedTime=null,this._callbacks={onresult:null},n(zt,`configured for probing every ${this._config.refreshEvery}ms`),n(zt,`configured for starting after ${this._config.startAfter}ms`),n(zt,this._config.stopAfter&&-1===this._config.stopAfter?"configured for never stopped":`configured for stopped after ${this._config.stopAfter}ms`),o(zt,"engine initialized")}get probes(){return this._probes}get isRunning(){return this._probes.some((t=>t.isRunning))}get isIdle(){return this._probes.every((t=>t.isIdle))}addNewProbe(t,e){if(!t)throw new Error("undefined peer connection");const a=((t,e={},a={})=>{const s={...a,...e};return e.pname||l(et,`Argument [String] 'cfg.pname' for the peerConnection name or id is missing - use generated '${a.pname}'`),e.cid||l(et,`Argument [String] 'cfg.cid' for the call name or id is missing - use generated '${a.cid}'`),e.uid||l(et,`Argument [String] 'cfg.uid' for the user name or id is missing - use generated '${a.uid}'`),s.pc=t,s})(t,e,this._config),s=new Dt(a);return this._probes.push(s),o(zt,`${this._probes.length} probes registered`),s}removeExistingProbe(t){if(!t)throw new Error("undefined probe");t.state===y&&t.stop(),this._probes=this._probes.filter((e=>t.id!==e.id))}async start(){const t=()=>!this.isIdle&&(!this._config.stopAfter||this._config.stopAfter<0||Date.now()<this._startedTime+this._config.stopAfter),e=async()=>{const t={delta_time_to_measure_probes_ms:0,delta_time_consumed_to_measure_ms:0,delta_KBytes_in:0,delta_KBytes_out:0,delta_kbs_in:0,delta_kbs_out:0,total_time_decoded_in:0,total_time_encoded_out:0,probes:[]},e=this._probes.filter((t=>t.isRunning));for(const a of e){const e=await a.collectStats();e&&t.probes.push(e),o(zt,`got probe ${a.id}`),await ot(0)}return t.delta_time_to_measure_probes_ms=_t(t.probes,"experimental","time_to_measure_ms"),t.delta_KBytes_in=_t(t.probes,"data","delta_KBytes_in"),t.delta_KBytes_out=_t(t.probes,"data","delta_KBytes_out"),t.delta_kbs_in=_t(t.probes,"data","delta_kbs_in"),t.delta_kbs_out=_t(t.probes,"data","delta_kbs_out"),t.total_time_decoded_in=_t(t.probes,"video","total_time_decoded_in"),t.total_time_encoded_out=_t(t.probes,"video","total_time_encoded_out"),t};for(o(zt,"starting to collect"),(()=>{this._probes.forEach((t=>t.start()))})(),o(zt,"generating reference reports..."),await(async()=>Promise.all(this._probes.map((t=>t.takeReferenceStats()))))(),o(zt,"reference reports generated"),this._startedTime=Date.now(),o(zt,`wait ${this._config.refreshEvery}ms before collecting`),await ot(this._config.refreshEvery);t();){o(zt,"collecting...");const t=Date.now(),a=await e(),s=Date.now();a.delta_time_consumed_to_measure_ms=s-t,this.fireOnReports(a),o(zt,"collected"),o(zt,`wait ${this._config.refreshEvery}ms before collecting`),await ot(this._config.refreshEvery)}o(zt,"reaching end of the collecting period..."),this.isRunning&&setTimeout((()=>{this.stop()}),0)}stop(t){n(zt,"stop collecting"),(t=>{this._probes.forEach((e=>{e.stop(t)}))})(t)}registerCallback(t,e,a){t in this._callbacks?(this._callbacks[t]={callback:e,context:a},o(zt,`registered callback '${t}'`)):_(zt,`can't register callback for '${t}' - not found`)}unregisterCallback(t){t in this._callbacks?(this._callbacks[t]=null,delete this._callbacks[t],o(this._moduleName,`unregistered callback '${t}'`)):_(this._moduleName,`can't unregister callback for '${t}' - not found`)}fireOnReports(t){this._callbacks.onresult&&t.probes.length>0&&rt(this._callbacks.onresult.callback,this._callbacks.onresult.context,t)}}class At{constructor(a){var s;this._config=((t={})=>{const e={...k,...t};return e.name="WebRTCMetrics",e.version="5.3.3",e})(a),n("interface   ",`welcome to ${this._config.name} version ${this._config.version}`),s=this._config.verbose||!1,t.info(i(e(),"log         ","set log level to "+(s?"verbose":"info"))),t.setLevel(s?t.levels.TRACE:t.levels.INFO),this._engine=new Mt(this._config)}setupLogLevel(a){(a=>{const s=[...Object.keys(t.levels)];s.includes(a)?(t.info(i(e(),"log         ",`update log level to ${a.toLowerCase()}`)),t.setLevel(a)):t.warn(i(e(),"log         ","Incorrect log level please choose one of "),s)})(a)}get version(){return this._config.version}get name(){return this._config.name}get probes(){return this._engine.probes}createProbe(t,e){return this._engine.addNewProbe(t,e)}startAllProbes(){this._engine.start()}stopAllProbes(){this._engine.stop()}get running(){return this._engine.isRunning}get idle(){return this._engine.isIdle}removeProbe(t){this._engine.removeExistingProbe(t)}set onresult(t){t?this._engine.registerCallback("onresult",t):this._engine.unregisterCallback("onresult")}getTicket(t){return t.getTicket()}}})(),s.default})()));