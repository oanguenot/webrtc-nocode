!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.WebRTCMetrics=e():t.WebRTCMetrics=e()}(self,(function(){return(()=>{var t={43:function(t,e,s){var o,i;!function(a,r){"use strict";o=function(){var t=function(){},e="undefined",s=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"];function i(t,e){var s=t[e];if("function"==typeof s.bind)return s.bind(t);try{return Function.prototype.bind.call(s,t)}catch(e){return function(){return Function.prototype.apply.apply(s,[t,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function r(o){return"debug"===o&&(o="log"),typeof console!==e&&("trace"===o&&s?a:void 0!==console[o]?i(console,o):void 0!==console.log?i(console,"log"):t)}function n(e,s){for(var i=0;i<o.length;i++){var a=o[i];this[a]=i<e?t:this.methodFactory(a,e,s)}this.log=this.debug}function l(t,s,o){return function(){typeof console!==e&&(n.call(this,s,o),this[t].apply(this,arguments))}}function _(t,e,s){return r(t)||l.apply(this,arguments)}function c(t,s,i){var a,r=this,l="loglevel";function c(){var t;if(typeof window!==e&&l){try{t=window.localStorage[l]}catch(t){}if(typeof t===e)try{var s=window.document.cookie,o=s.indexOf(encodeURIComponent(l)+"=");-1!==o&&(t=/^([^;]+)/.exec(s.slice(o))[1])}catch(t){}return void 0===r.levels[t]&&(t=void 0),t}}"string"==typeof t?l+=":"+t:"symbol"==typeof t&&(l=void 0),r.name=t,r.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},r.methodFactory=i||_,r.getLevel=function(){return a},r.setLevel=function(s,i){if("string"==typeof s&&void 0!==r.levels[s.toUpperCase()]&&(s=r.levels[s.toUpperCase()]),!("number"==typeof s&&s>=0&&s<=r.levels.SILENT))throw"log.setLevel() called with invalid level: "+s;if(a=s,!1!==i&&function(t){var s=(o[t]||"silent").toUpperCase();if(typeof window!==e&&l){try{return void(window.localStorage[l]=s)}catch(t){}try{window.document.cookie=encodeURIComponent(l)+"="+s+";"}catch(t){}}}(s),n.call(r,s,t),typeof console===e&&s<r.levels.SILENT)return"No console available for logging"},r.setDefaultLevel=function(t){c()||r.setLevel(t,!1)},r.enableAll=function(t){r.setLevel(r.levels.TRACE,t)},r.disableAll=function(t){r.setLevel(r.levels.SILENT,t)};var u=c();null==u&&(u=null==s?"WARN":s),r.setLevel(u,!1)}var u=new c,d={};u.getLogger=function(t){if("symbol"!=typeof t&&"string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=d[t];return e||(e=d[t]=new c(t,u.getLevel(),u.methodFactory)),e};var p=typeof window!==e?window.log:void 0;return u.noConflict=function(){return typeof window!==e&&window.log===u&&(window.log=p),u},u.getLoggers=function(){return d},u.default=u,u},void 0===(i=o.call(e,s,e,t))||(t.exports=i)}()},666:t=>{var e=function(t){"use strict";var e,s=Object.prototype,o=s.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",r=i.asyncIterator||"@@asyncIterator",n=i.toStringTag||"@@toStringTag";function l(t,e,s){return Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,s){return t[e]=s}}function _(t,e,s,o){var i=e&&e.prototype instanceof v?e:v,a=Object.create(i.prototype),r=new S(o||[]);return a._invoke=function(t,e,s){var o=u;return function(i,a){if(o===p)throw new Error("Generator is already running");if(o===h){if("throw"===i)throw a;return L()}for(s.method=i,s.arg=a;;){var r=s.delegate;if(r){var n=R(r,s);if(n){if(n===m)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if(o===u)throw o=h,s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);o=p;var l=c(t,e,s);if("normal"===l.type){if(o=s.done?h:d,l.arg===m)continue;return{value:l.arg,done:s.done}}"throw"===l.type&&(o=h,s.method="throw",s.arg=l.arg)}}}(t,s,r),a}function c(t,e,s){try{return{type:"normal",arg:t.call(e,s)}}catch(t){return{type:"throw",arg:t}}}t.wrap=_;var u="suspendedStart",d="suspendedYield",p="executing",h="completed",m={};function v(){}function y(){}function f(){}var g={};g[a]=function(){return this};var b=Object.getPrototypeOf,k=b&&b(b(T([])));k&&k!==s&&o.call(k,a)&&(g=k);var w=f.prototype=v.prototype=Object.create(g);function C(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function s(i,a,r,n){var l=c(t[i],t,a);if("throw"!==l.type){var _=l.arg,u=_.value;return u&&"object"==typeof u&&o.call(u,"__await")?e.resolve(u.__await).then((function(t){s("next",t,r,n)}),(function(t){s("throw",t,r,n)})):e.resolve(u).then((function(t){_.value=t,r(_)}),(function(t){return s("throw",t,r,n)}))}n(l.arg)}var i;this._invoke=function(t,o){function a(){return new e((function(e,i){s(t,o,e,i)}))}return i=i?i.then(a,a):a()}}function R(t,s){var o=t.iterator[s.method];if(o===e){if(s.delegate=null,"throw"===s.method){if(t.iterator.return&&(s.method="return",s.arg=e,R(t,s),"throw"===s.method))return m;s.method="throw",s.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var i=c(o,t.iterator,s.arg);if("throw"===i.type)return s.method="throw",s.arg=i.arg,s.delegate=null,m;var a=i.arg;return a?a.done?(s[t.resultName]=a.value,s.next=t.nextLoc,"return"!==s.method&&(s.method="next",s.arg=e),s.delegate=null,m):a:(s.method="throw",s.arg=new TypeError("iterator result is not an object"),s.delegate=null,m)}function B(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function O(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function S(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(B,this),this.reset(!0)}function T(t){if(t){var s=t[a];if(s)return s.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,r=function s(){for(;++i<t.length;)if(o.call(t,i))return s.value=t[i],s.done=!1,s;return s.value=e,s.done=!0,s};return r.next=r}}return{next:L}}function L(){return{value:e,done:!0}}return y.prototype=w.constructor=f,f.constructor=y,y.displayName=l(f,n,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,f):(t.__proto__=f,l(t,n,"GeneratorFunction")),t.prototype=Object.create(w),t},t.awrap=function(t){return{__await:t}},C(x.prototype),x.prototype[r]=function(){return this},t.AsyncIterator=x,t.async=function(e,s,o,i,a){void 0===a&&(a=Promise);var r=new x(_(e,s,o,i),a);return t.isGeneratorFunction(s)?r:r.next().then((function(t){return t.done?t.value:r.next()}))},C(w),l(w,n,"Generator"),w[a]=function(){return this},w.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var s in t)e.push(s);return e.reverse(),function s(){for(;e.length;){var o=e.pop();if(o in t)return s.value=o,s.done=!1,s}return s.done=!0,s}},t.values=T,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var s in this)"t"===s.charAt(0)&&o.call(this,s)&&!isNaN(+s.slice(1))&&(this[s]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var s=this;function i(o,i){return n.type="throw",n.arg=t,s.next=o,i&&(s.method="next",s.arg=e),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var r=this.tryEntries[a],n=r.completion;if("root"===r.tryLoc)return i("end");if(r.tryLoc<=this.prev){var l=o.call(r,"catchLoc"),_=o.call(r,"finallyLoc");if(l&&_){if(this.prev<r.catchLoc)return i(r.catchLoc,!0);if(this.prev<r.finallyLoc)return i(r.finallyLoc)}else if(l){if(this.prev<r.catchLoc)return i(r.catchLoc,!0)}else{if(!_)throw new Error("try statement without catch or finally");if(this.prev<r.finallyLoc)return i(r.finallyLoc)}}}},abrupt:function(t,e){for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s];if(i.tryLoc<=this.prev&&o.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var r=a?a.completion:{};return r.type=t,r.arg=e,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(r)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var s=this.tryEntries[e];if(s.finallyLoc===t)return this.complete(s.completion,s.afterLoc),O(s),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var s=this.tryEntries[e];if(s.tryLoc===t){var o=s.completion;if("throw"===o.type){var i=o.arg;O(s)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,s,o){return this.delegate={iterator:T(t),resultName:s,nextLoc:o},"next"===this.method&&(this.arg=e),m}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}},913:t=>{var e=(()=>{var t=Object.defineProperty,e=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(e,s,o)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[s]=o,a=(t,a)=>{for(var r in a||(a={}))s.call(a,r)&&i(t,r,a[r]);if(e)for(var r of e(a))o.call(a,r)&&i(t,r,a[r]);return t},r={};((e,s)=>{for(var o in(e=>{t(e,"__esModule",{value:!0})})(e),s)t(e,o,{get:s[o],enumerable:!0})})(r,{DEFAULT_UUID_LENGTH:()=>n,default:()=>c});var n=6,l={dictionary:"alphanum",shuffle:!0,debug:!1,length:n},_=class extends Function{constructor(t={}){super(),this.dictIndex=0,this.dictRange=[],this.lowerBound=0,this.upperBound=0,this.dictLength=0,this._digit_first_ascii=48,this._digit_last_ascii=58,this._alpha_lower_first_ascii=97,this._alpha_lower_last_ascii=123,this._hex_last_ascii=103,this._alpha_upper_first_ascii=65,this._alpha_upper_last_ascii=91,this._number_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii]},this._alpha_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alpha_lower_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alpha_upper_dict_ranges={upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_lower_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alphanum_upper_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._hex_dict_ranges={decDigits:[this._digit_first_ascii,this._digit_last_ascii],alphaDigits:[this._alpha_lower_first_ascii,this._hex_last_ascii]},this.log=(...t)=>{const e=[...t];if(e[0]=`[short-unique-id] ${t[0]}`,!0===this.debug&&"undefined"!=typeof console&&null!==console)return console.log(...e)},this.setDictionary=(t,e)=>{let s;if(t&&Array.isArray(t)&&t.length>1)s=t;else{let e;s=[],this.dictIndex=e=0;const o=this[`_${t}_dict_ranges`];Object.keys(o).forEach((t=>{const i=t;for(this.dictRange=o[i],this.lowerBound=this.dictRange[0],this.upperBound=this.dictRange[1],this.dictIndex=e=this.lowerBound;this.lowerBound<=this.upperBound?e<this.upperBound:e>this.upperBound;this.dictIndex=this.lowerBound<=this.upperBound?e+=1:e-=1)s.push(String.fromCharCode(this.dictIndex))}))}if(e){const t=.5;s=s.sort((()=>Math.random()-t))}this.dict=s,this.dictLength=this.dict.length,this.counter=0},this.seq=()=>this.sequentialUUID(),this.sequentialUUID=()=>{let t,e,s="";t=this.counter;do{e=t%this.dictLength,t=Math.trunc(t/this.dictLength),s+=this.dict[e]}while(0!==t);return this.counter+=1,s},this.randomUUID=(t=this.uuidLength||n)=>{let e,s,o;if(null==t||t<1)throw new Error("Invalid UUID Length Provided");for(e="",o=0;o<t;o+=1)s=parseInt((Math.random()*this.dictLength).toFixed(0),10)%this.dictLength,e+=this.dict[s];return e},this.availableUUIDs=(t=this.uuidLength)=>parseFloat(Math.pow([...new Set(this.dict)].length,t).toFixed(0)),this.approxMaxBeforeCollision=(t=this.availableUUIDs(this.uuidLength))=>parseFloat(Math.sqrt(Math.PI/2*t).toFixed(20)),this.collisionProbability=(t=this.availableUUIDs(this.uuidLength),e=this.uuidLength)=>parseFloat((this.approxMaxBeforeCollision(t)/this.availableUUIDs(e)).toFixed(20)),this.uniqueness=(t=this.availableUUIDs(this.uuidLength))=>{const e=parseFloat((1-this.approxMaxBeforeCollision(t)/t).toFixed(20));return e>1?1:e<0?0:e},this.getVersion=()=>this.version,this.stamp=t=>{if("number"!=typeof t||t<10)throw new Error("Param finalLength must be number greater than 10");const e=Math.floor(+new Date/1e3).toString(16),s=t-9,o=Math.round(Math.random()*(s>15?15:s)),i=this.randomUUID(s);return`${i.substr(0,o)}${e}${i.substr(o)}${o.toString(16)}`},this.parseStamp=t=>{if(t.length<10)throw new Error("Stamp length invalid");const e=parseInt(t.substr(t.length-1,1),16);return new Date(1e3*parseInt(t.substr(e,8),16))};const e=a(a({},l),t);this.counter=0,this.debug=!1,this.dict=[],this.version="4.4.4";const{dictionary:s,shuffle:o,length:i}=e;return this.uuidLength=i,this.setDictionary(s,o),this.debug=e.debug,this.log(this.dict),this.log(`Generator instantiated with Dictionary Size ${this.dictLength}`),new Proxy(this,{apply:(t,e,s)=>this.randomUUID(...s)})}},c=_;return c.default=_,r})();t.exports=e.default,"undefined"!=typeof window&&(e=e.default)}},e={};function s(o){var i=e[o];if(void 0!==i)return i.exports;var a=e[o]={exports:{}};return t[o].call(a.exports,a,a.exports,s),a.exports}s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var o in e)s.o(e,o)&&!s.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var o={};return(()=>{"use strict";s.d(o,{default:()=>Ft}),s(666);var t=s(43);const e=()=>`${(new Date).toISOString()} | metrics`,i=(t,e,s)=>`${t} | ${e} | ${s}`;t.setDefaultLevel(t.levels.TRACE);const a=(s,o,a)=>{a?t.debug(i(e(),s,o),a):t.debug(i(e(),s,o))},r=(s,o)=>{t.info(i(e(),s,o))},n=(s,o)=>{t.info(i(e(),s,o))},l=(s,o)=>{t.warn(i(e(),s,o))},_=(s,o)=>{t.error(i(e(),s,o))};var c=s(913),u=s.n(c);const d=new(u()),p="inbound",h="outbound",m="idle",v="running",y={level_in:0,codec_id_in:"",codec_in:{mime_type:null,clock_rate:null,sdp_fmtp_line:null},delta_jitter_ms_in:0,delta_rtt_ms_in:null,total_rtt_ms_in:0,total_rtt_measure_in:0,percent_packets_lost_in:0,delta_packets_in:0,delta_packets_lost_in:0,total_packets_in:0,total_packets_lost_in:0,total_KBytes_in:0,delta_KBytes_in:0,delta_kbs_in:0,timestamp_in:null,mos_in:1,mos_emodel_in:1,mos_fullband_in:1,track_in:"",ssrc:"",direction:p},f={active_out:null,level_out:0,codec_id_out:"",codec_out:{mime_type:null,clock_rate:null,sdp_fmtp_line:null},delta_jitter_ms_out:0,delta_rtt_ms_out:null,total_rtt_ms_out:0,total_rtt_measure_out:0,percent_packets_lost_out:0,delta_packets_out:0,delta_packets_lost_out:0,total_packets_out:0,total_packets_lost_out:0,total_KBytes_out:0,delta_KBytes_out:0,delta_kbs_out:0,timestamp_out:null,mos_out:1,mos_emodel_out:1,mos_fullband_out:1,track_out:"",device_out:"",ssrc:"",direction:h},g={codec_id_in:"",size_in:{width:0,height:0,framerate:0},codec_in:{mime_type:null,clock_rate:null},delta_jitter_ms_in:0,percent_packets_lost_in:0,delta_packets_in:0,delta_packets_lost_in:0,total_packets_in:0,total_packets_lost_in:0,total_KBytes_in:0,delta_KBytes_in:0,delta_kbs_in:0,delta_glitch_in:{freeze:0,pause:0},total_glitch_in:{freeze:0,pause:0},decoder_in:null,delta_ms_decode_frame_in:0,total_frames_decoded_in:0,total_time_decoded_in:0,delta_nack_sent_in:0,delta_pli_sent_in:0,total_nack_sent_in:0,total_pli_sent_in:0,track_in:"",ssrc:"",direction:p},b={active_out:null,codec_id_out:"",size_out:{width:0,height:0,framerate:0},size_pref_out:{width:0,height:0,framerate:0},codec_out:{mime_type:null,clock_rate:null},delta_jitter_ms_out:0,delta_rtt_ms_out:null,total_rtt_ms_out:0,total_rtt_measure_out:0,percent_packets_lost_out:0,delta_packets_out:0,delta_packets_lost_out:0,total_packets_out:0,total_packets_lost_out:0,total_KBytes_out:0,delta_KBytes_out:0,delta_kbs_out:0,encoder_out:null,delta_ms_encode_frame_out:0,total_time_encoded_out:0,total_frames_encoded_out:0,delta_nack_received_out:0,delta_pli_received_out:0,total_nack_received_out:0,total_pli_received_out:0,limitation_out:{reason:null,durations:null,resolutionChanges:0},timestamp_out:null,track_out:"",device_out:"",ssrc:"",direction:h},k={refreshEvery:2e3,startAfter:0,stopAfter:-1,verbose:!1,pname:`p-${d()}`,cid:`c-${d()}`,uid:`u-${d()}`,record:!1,ticket:!0,passthrough:{}},w="inbound-rtp",C="bytesReceived",x="bytesSent",R="currentRoundTripTime",B="fractionLost",O="frameHeight",S="frameWidth",T="framesDecoded",L="framesEncoded",K="freezeCount",j="qualityLimitationReason",N="qualityLimitationDurations",E="qualityLimitationResolutionChanges",P="jitter",$="nackCount",I="networkType",D="packetsLost",M="packetsReceived",F="packetsSent",z="pauseCount",U="pliCount",A="responsesReceived",J="roundTripTime",q="selected",G="totalDecodeTime",W="totalEncodeTime",H="totalRoundTripTime",Y="roundTripTimeMeasurements",V="audio",Q="video",X="data",Z="audio",tt="video",et="network",st="data",ot="config      ",it=new(u()),at=(t,e,s,o=!1,i,a=!1)=>{let r=t.map((t=>{if(!s)return a?{timestamp:new Date(t.timestamp).toJSON(),value:t[e]}:t[e];if(!i)return a?{timestamp:new Date(t.timestamp).toJSON(),value:t[e][s]}:t[e][s];const o=t[e][i];return o?a?{timestamp:new Date(t.timestamp).toJSON(),value:o[s]}:o[s]:null}));return r=r.filter((t=>a?o?t&&Number.isFinite(t.value)&&t.value>0:t&&Number.isFinite(t.value):o?Number.isFinite(t)&&t>0:Number.isFinite(t))),0===r.length?[]:r},rt=(t,e)=>{const s=t.filter((t=>null!==t));return s.length>0?s.reduce(((t,e)=>t+e),0)/t.length:e},nt=t=>new Promise((e=>setTimeout(e,t))),lt=(t,e,s)=>{e?t.call(e,s):t(s)},_t=(t,e,s,o)=>{const i=at(t,e,s,!0,o);if(0===i.length)return null;const a=i.reduce(((t,e)=>t+e),0)/i.length;return 0===a?null:i.map((t=>Math.abs(a-t))).reduce(((t,e)=>t+e),0)/i.length*100/a},ct=(t,e,s,o=!1,i)=>{const a=at(t,e,s,o,i);return 0===a.length?null:a.reduce(((t,e)=>t+e),0)/a.length},ut=(t,e,s)=>at(t,e,s).reduce(((t,e)=>t+e),0),dt=(t,e,s,o)=>{const i=at(t,e,s,!0,o);return 0===i.length?null:Math.min(...i)},pt=(t,e,s,o)=>{const i=at(t,e,s,!1,o);return 0===i.length?null:Math.max(...i)},ht=(t,e,s,o)=>at(t,e,s,!1,o,!0),mt=(t,e,s,o)=>{const i=t.slice().pop();if(!i)return null;if(!s)return i[e];if(!o)return i[e][s];const a=i[e][o];return a?a[s]:null},vt=(t,e,s)=>{if(!e)return null;const o={};let i=e.audio[t];i||(i=s===p?{...y}:{...f}),o.audio=i;let a=e.video[t];return a||(a=s===p?{...g}:{...b}),o.video=a,o},yt=(t,e)=>{const s=e.getSenders().find((e=>e.track&&e.track.kind===t));return s?s.track:null},ft="exporter    ",gt=(t,e,s,o=!1)=>{if(!t||0===t.length)return 0;const i=t[t.length-1];if(!i)return 0;const a=i[e][s];if(a){const i=o?a.total_rtt_ms_in:a.total_rtt_ms_out,r=o?a.total_rtt_measure_in:a.total_rtt_measure_out;return r&&i?Number(i/r):ct(t,e,o?"delta_rtt_ms_in":"delta_rtt_ms_out",!1,s)}return null},bt=(t,e)=>{if(!t||0===t.length)return 0;const s=t[t.length-1];if(!s)return 0;const o=s[e].total_rtt_connectivity_ms,i=s[e].total_rtt_connectivity_measure;return i&&o?Number(o/i):ct(t,e,"delta_rtt_connectivity_ms")},kt=t=>{const e=mt(t,"network","remote_candidate_type"),s=mt(t,"network","remote_candidate_protocol");return"relay"!==e?`direct/${s}`:`turn/${s}`};class wt{constructor(t){this._start=null,this._end=null,this._cfg=t,this._referenceReport=null,this._reports=[],this._events=[]}start(){r(ft,"start() - start exporter...");const t=new Date;return this._start=t.toJSON(),t}stop(){r(ft,"stop() - stop exporter...");const t=new Date;return this._end=t.toJSON(),t}saveReferenceReport(t){this._referenceReport=t}getReferenceReport(){return this._referenceReport}addReport(t){this._cfg.ticket&&(a(ft,`addReport() - add report to exporter at ${t.timestamp}`),this._reports.push(t))}addCustomEvent(t){this._events.push(t)}reset(){r(ft,"resetReports() - reset reports"),this._reports=[],this._referenceReport=null,this._start=null,this._end=null}get ticket(){a(ft,"ticket() - generate ticket");const t=mt(this._reports,"audio","total_packets_lost_in"),e=mt(this._reports,"audio","total_packets_in"),s=mt(this._reports,"video","total_packets_lost_in"),o=mt(this._reports,"video","total_packets_in"),i={},r=this._reports.slice().pop();return r&&(Object.keys(r.audio).forEach((t=>{const e=r.audio[t];if(i[e.ssrc]={type:V,direction:e.direction},e.direction===p){const e={avg:ct(this._reports,V,"delta_jitter_ms_in",!1,t),min:dt(this._reports,V,"delta_jitter_ms_in",t),max:pt(this._reports,V,"delta_jitter_ms_in",t),volatility:_t(this._reports,V,"delta_jitter_ms_in",t),values:ht(this._reports,V,"delta_jitter_ms_in",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},s={avg:ct(this._reports,V,"delta_kbs_in",!1,t),min:dt(this._reports,V,"delta_kbs_in",t),max:pt(this._reports,V,"delta_kbs_in",t),volatility:_t(this._reports,V,"delta_kbs_in",t),values:ht(this._reports,V,"delta_kbs_in",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},o={avg:ct(this._reports,V,"delta_KBytes_in",!1,t),min:dt(this._reports,V,"delta_KBytes_in",t),max:pt(this._reports,V,"delta_KBytes_in",t),volatility:_t(this._reports,V,"delta_KBytes_in",t),values:ht(this._reports,V,"delta_KBytes_in",t),_unit:{avg:"KB",min:"KB",max:"KB",volatility:"percent"}},a={emodel:{avg:ct(this._reports,V,"mos_fullband_in",!1,t),min:dt(this._reports,V,"mos_fullband_in",t),max:pt(this._reports,V,"mos_fullband_in",t),volatility:_t(this._reports,V,"mos_fullband_in",t),values:ht(this._reports,V,"mos_fullband_in",t)},effective:{avg:ct(this._reports,V,"mos_in",!1,t),min:dt(this._reports,V,"mos_in",t),max:pt(this._reports,V,"mos_in",t),volatility:_t(this._reports,V,"mos_in",t),values:ht(this._reports,V,"mos_in",t)},_unit:{avg:"number (1-5)",min:"number (1-5)",max:"number (1-5)",volatility:"percent"}},r=mt(this._reports,V,"total_packets_lost_in",t),n=mt(this._reports,V,"total_packets_in",t),l={lost:r,avg:Math.round(100*(r/(r+n)*100||0))/100,values:ht(this._reports,V,"delta_packets_lost_in",t),_unit:{avg:"percent",lost:"number"}},_={avg:gt(this._reports,V,t,!0),min:dt(this._reports,V,"delta_rtt_ms_in",t),max:pt(this._reports,V,"delta_rtt_ms_in",t),volatility:_t(this._reports,V,"delta_rtt_ms_in",t),values:ht(this._reports,V,"delta_rtt_ms_in",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}};i[t].jitter=e,i[t].rtt=_,i[t].mos=a,i[t].traffic=o,i[t].bitrate=s,i[t].loss=l}else{const e={avg:ct(this._reports,V,"delta_jitter_ms_out",!1,t),min:dt(this._reports,V,"delta_jitter_ms_out",t),max:pt(this._reports,V,"delta_jitter_ms_out",t),volatility:_t(this._reports,V,"delta_jitter_ms_out",t),values:ht(this._reports,V,"delta_jitter_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},s={avg:ct(this._reports,V,"delta_kbs_out",!1,t),min:dt(this._reports,V,"delta_kbs_out",t),max:pt(this._reports,V,"delta_kbs_out",t),volatility:_t(this._reports,V,"delta_kbs_out",t),values:ht(this._reports,V,"delta_kbs_out",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},o={avg:ct(this._reports,V,"delta_KBytes_out",!1,t),min:dt(this._reports,V,"delta_KBytes_out",t),max:pt(this._reports,V,"delta_KBytes_out",t),volatility:_t(this._reports,V,"delta_KBytes_out",t),values:ht(this._reports,V,"delta_KBytes_out",t),_unit:{avg:"KB",min:"KB",max:"KB",bitrate:"kbs",volatility:"percent"}},a={avg:gt(this._reports,V,t),min:dt(this._reports,V,"delta_rtt_ms_out",t),max:pt(this._reports,V,"delta_rtt_ms_out",t),volatility:_t(this._reports,V,"delta_rtt_ms_out",t),values:ht(this._reports,V,"delta_rtt_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},r=mt(this._reports,V,"total_packets_lost_out",t),n=mt(this._reports,V,"total_packets_out",t),l={lost:r,avg:Math.round(100*(r/(r+n)*100||0))/100,values:ht(this._reports,V,"delta_packets_lost_out",t),_unit:{avg:"percent",lost:"number"}},_={emodel:{avg:ct(this._reports,V,"mos_fullband_out",!1,t),min:dt(this._reports,V,"mos_fullband_out",t),max:pt(this._reports,V,"mos_fullband_out",t),volatility:_t(this._reports,V,"mos_fullband_out",t),values:ht(this._reports,V,"mos_fullband_out",t)},effective:{avg:ct(this._reports,V,"mos_out",!1,t),min:dt(this._reports,V,"mos_out",t),max:pt(this._reports,V,"mos_out",t),volatility:_t(this._reports,V,"mos_out",t),values:ht(this._reports,V,"mos_out",t)},_unit:{avg:"number (1-5)",min:"number (1-5)",max:"number (1-5)",volatility:"percent"}};i[t].jitter=e,i[t].rtt=a,i[t].traffic=o,i[t].bitrate=s,i[t].loss=l,i[t].mos=_}})),Object.keys(r.video).forEach((t=>{const e=r.video[t];if(i[t]={type:Q,direction:e.direction},e.direction===p){const e={avg:ct(this._reports,Q,"delta_jitter_ms_in",!1,t),min:dt(this._reports,Q,"delta_jitter_ms_in",t),max:pt(this._reports,Q,"delta_jitter_ms_in",t),volatility:_t(this._reports,Q,"delta_jitter_ms_in",t),values:ht(this._reports,Q,"delta_jitter_ms_in",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},s={avg:ct(this._reports,Q,"delta_kbs_in",!1,t),min:dt(this._reports,Q,"delta_kbs_in",t),max:pt(this._reports,Q,"delta_kbs_in",t),volatility:_t(this._reports,Q,"delta_kbs_in",t),values:ht(this._reports,Q,"delta_kbs_in",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},o={avg:ct(this._reports,Q,"delta_KBytes_in",!1,t),min:dt(this._reports,Q,"delta_KBytes_in",t),max:pt(this._reports,Q,"delta_KBytes_in",t),volatility:_t(this._reports,Q,"delta_KBytes_in",t),values:ht(this._reports,Q,"delta_KBytes_in",t),_unit:{avg:"KB",min:"KB",max:"KB",volatility:"percent"}},a=mt(this._reports,Q,"total_packets_lost_in",t),r=mt(this._reports,Q,"total_packets_in",t),n={lost:a,avg:Math.round(100*(a/(a+r)*100||0))/100,values:ht(this._reports,Q,"delta_packets_lost_in",t),_unit:{avg:"percent",lost:"number"}};i[t].jitter=e,i[t].traffic=o,i[t].bitrate=s,i[t].loss=n}else{const e={avg:ct(this._reports,Q,"delta_jitter_ms_out",!1,t),min:dt(this._reports,Q,"delta_jitter_ms_out",t),max:pt(this._reports,Q,"delta_jitter_ms_out",t),volatility:_t(this._reports,Q,"delta_jitter_ms_out",t),values:ht(this._reports,Q,"delta_jitter_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},s={avg:ct(this._reports,Q,"delta_kbs_out",!1,t),min:dt(this._reports,Q,"delta_kbs_out",t),max:pt(this._reports,Q,"delta_kbs_out",t),volatility:_t(this._reports,Q,"delta_kbs_out",t),values:ht(this._reports,Q,"delta_kbs_out",t),_unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},o={avg:ct(this._reports,Q,"delta_KBytes_out",!1,t),min:dt(this._reports,Q,"delta_KBytes_out",t),max:pt(this._reports,Q,"delta_KBytes_out",t),volatility:_t(this._reports,Q,"delta_KBytes_out",t),values:ht(this._reports,Q,"delta_KBytes_out",t),_unit:{avg:"KB",min:"KB",max:"KB",volatility:"percent"}},a={avg:gt(this._reports,Q,t),min:dt(this._reports,Q,"delta_rtt_ms_out",t),max:pt(this._reports,Q,"delta_rtt_ms_out",t),volatility:_t(this._reports,Q,"delta_rtt_ms_out",t),values:ht(this._reports,Q,"delta_rtt_ms_out",t),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},r=mt(this._reports,Q,"total_packets_lost_out",t),n=mt(this._reports,Q,"total_packets_out",t),l={lost:r,avg:Math.round(100*(r/(r+n)*100||0))/100,values:ht(this._reports,Q,"delta_packets_lost_out",t),_unit:{avg:"percent",lost:"number"}};i[t].jitter=e,i[t].rtt=a,i[t].traffic=o,i[t].bitrate=s,i[t].loss=l,i[t].limitations=((t,e,s)=>{const o={other:0,cpu:0,bandwidth:0,none:100};if(!t||0===t.length)return o;const i=t[t.length-1].video[s];if(!i)return o;if(!("limitation_out"in i)||!("durations"in i.limitation_out))return o;if(!i.limitation_out.durations)return o;const{other:a,bandwidth:r,cpu:n,none:l}=i.limitation_out.durations,_=Number(a)+Number(r)+Number(n)+Number(l);return{other:+(a/_*100).toFixed(2),cpu:+(n/_*100).toFixed(2),bandwidth:+(r/_*100).toFixed(2),none:+(l/_*100).toFixed(2)}})(this._reports,0,t)}}))),{version:"2.0",configuration:{frequency:this._cfg.refreshEvery},started:this._start,ended:this._end,ua:{agent:navigator.userAgent,pname:this._cfg.pname,user_id:this._cfg.uid},call:{call_id:this._cfg.cid,events:this._events},details:{count:this._reports.length,reports:this._cfg.record?this._reports:[],reference:this._referenceReport||null},ssrc:i,data:{rtt:{avg:bt(this._reports,"data"),min:dt(this._reports,X,"delta_rtt_connectivity_ms"),max:pt(this._reports,X,"delta_rtt_connectivity_ms"),volatility:_t(this._reports,X,"delta_rtt_connectivity_ms"),values:ht(this._reports,X,"delta_rtt_connectivity_ms"),_unit:{avg:"ms",min:"ms",max:"ms",volatility:"percent"}},packetsLost:{audio:{in:{avg:Math.round(100*(t/(t+e)*100||0))/100}},video:{in:{avg:Math.round(100*(s/(s+o)*100||0))/100}},unit:{avg:"percent"}},bitrate:{in:{avg:ct(this._reports,"data","delta_kbs_in"),min:dt(this._reports,"data","delta_kbs_in"),max:pt(this._reports,"data","delta_kbs_in"),volatility:_t(this._reports,"data","delta_kbs_in"),values:ht(this._reports,X,"delta_kbs_in")},out:{avg:ct(this._reports,"data","delta_kbs_out"),min:dt(this._reports,"data","delta_kbs_out"),max:pt(this._reports,"data","delta_kbs_out"),volatility:_t(this._reports,"data","delta_kbs_out"),values:ht(this._reports,X,"delta_kbs_out")},unit:{avg:"kbs",min:"kbs",max:"kbs",volatility:"percent"}},traffic:{in:{avg:ct(this._reports,"data","delta_KBytes_in"),min:dt(this._reports,"data","delta_KBytes_in"),max:pt(this._reports,"data","delta_KBytes_in"),volatility:_t(this._reports,"data","delta_KBytes_in"),values:ht(this._reports,X,"delta_KBytes_in")},out:{avg:ct(this._reports,"data","delta_KBytes_out"),min:dt(this._reports,"data","delta_KBytes_out"),max:pt(this._reports,"data","delta_KBytes_out"),volatility:_t(this._reports,"data","delta_KBytes_out"),values:ht(this._reports,X,"delta_KBytes_out")},unit:{avg:"KBytes",min:"KBytes",max:"KBytes",volatility:"percent"}},network:{localConnection:(n=this._reports,"relay"!==mt(n,"network","local_candidate_type")?`direct/${mt(n,"network","local_candidate_protocol")}`:`turn/${mt(n,"network","local_candidate_relay_protocol")}`),remoteConnection:kt(this._reports)}}};var n}updateConfig(t){this._cfg=t}getLastReport(){return this._reports.slice().pop()||null}getBeforeLastReport(){const t=this._reports.slice();return t.pop(),t.pop()||null}getReportsNumber(){return this._reports.length}}const Ct=(t,e,s,o)=>{let i=!1;const a=o[e].total_rtt_ms_out,r=o[e].total_rtt_measure_out,n=s?s[e].total_rtt_ms_out:0,l=s?s[e].total_rtt_measure_out:0,_={rtt:null,totalRTT:a,totalRTTMeasurements:r};if(t.timestamp===o[e].timestamp_out)return _;if(!Object.prototype.hasOwnProperty.call(t,J))return _;if(Object.prototype.hasOwnProperty.call(t,Y)&&(i=!0,0===Number(t.roundTripTimeMeasurements)||Number(t.roundTripTimeMeasurements)-l===r))return _;const c=Number(1e3)*Number(t.roundTripTime);let u=a+c,d=r+1;return i&&(u=Number(1e3)*Number(t.totalRoundTripTime)-n,d=Number(t.roundTripTimeMeasurements)-l),{rtt:c,totalRTT:u,totalRTTMeasurements:d}},xt=(t,e,s)=>t.timestamp===s[e].timestamp_out?null:Object.prototype.hasOwnProperty.call(t,P)?Number(1e3)*(Number(t.jitter)||0):null,Rt=(t,e,s,o)=>{if(!Object.prototype.hasOwnProperty.call(t,F)||!Object.prototype.hasOwnProperty.call(t,x))return{packetsSent:s[e].total_packets_out,packetsLost:s[e].total_packets_lost_out,bytesSent:s[e].total_KBytes_out};const i=Number(t.packetsSent)||0-(o?o[e].total_packets_out:0),a=i-s[e].total_packets_out,r=Number(t.bytesSent)/1024-(o?o[e].total_KBytes_out:0),n=r-s[e].total_KBytes_out,l=t.timestamp||Date.now(),_=o?o.timestamp:null;let c=s.timestamp;!c&&_&&(c=_);const u=c?l-c:0;return{packetsSent:i,deltaPacketsSent:a,KBytesSent:r,deltaKBytesSent:n,kbsSent:u>0?.008*n*1024/u*1e3:0}},Bt=(t,e,s,o)=>{let i=s[e].total_packets_lost_out,a=0,r=0;return Object.prototype.hasOwnProperty.call(t,D)&&(i=Number(t.packetsLost)||0-(o?o[e].total_packets_lost_out:0),a=i-s[e].total_packets_lost_out),Object.prototype.hasOwnProperty.call(t,B)&&(r=Number(100*t.fractionLost)),{packetsLost:i,deltaPacketsLost:a,fractionLost:r}},Ot=(t,e,s,o)=>{if(!Object.prototype.hasOwnProperty.call(t,M)||!Object.prototype.hasOwnProperty.call(t,D)||!Object.prototype.hasOwnProperty.call(t,C))return{percent_packets_lost:s[e].percent_packets_lost_in,packetsReceived:s[e].total_packets_in,packetsLost:s[e].total_packets_lost_in,bytesReceived:s[e].total_KBytes_in};const i=Number(t.packetsReceived)||0-(o?o[e].total_packets_in:0),a=Number(t.packetsLost)||0-(o?o[e].total_packets_lost_in:0),r=a-s[e].total_packets_lost_in,n=i-s[e].total_packets_in,l=i!==s[e].total_packets_in?100*r/(r+n):0,_=Number(t.bytesReceived)/1024-(o?o[e].total_KBytes_in:0),c=_-s[e].total_KBytes_in,u=t.timestamp||Date.now(),d=o?o.timestamp:null;let p=s.timestamp;!p&&d&&(p=d);const h=p?u-p:0;return{percentPacketsLost:l,packetsReceived:i,deltaPacketsReceived:n,packetsLost:a,deltaPacketsLost:r,KBytesReceived:_,deltaKBytesReceived:c,kbsReceived:h>0?.008*c*1024/h*1e3:0}},St=t=>"relay"!==t.candidateType?"":t.relayProtocol||"",Tt=t=>{if(!Object.prototype.hasOwnProperty.call(t,I))return 3;switch(t.networkType){case"ethernet":return 0;case"cellular":return 5;case"wifi":return 3;default:return 10}},Lt=t=>Object.prototype.hasOwnProperty.call(t,O)&&Object.prototype.hasOwnProperty.call(t,S)?{width:t.frameWidth||0,height:t.frameHeight||0,framerate:t.framesPerSecond}:{width:0,height:0,framerate:0},Kt=(t,e)=>e||t<0?1:t>100?4.5:1+.035*t+7e-6*t*(t-60)*(100-t),jt=(t,e,s,o,i)=>({currentSSRCReport:vt(t,e,i),previousSSRCReport:vt(t,s,i),beforeLastSSRCReport:vt(t,o,i)}),Nt=(t,e,s,o,i,a)=>{const r=[],n=i===p?t[o].delta_jitter_ms_in:t[o].delta_jitter_ms_out;if(r.push(n,n,n,n),a>1){const t=i===p?e&&e[o].delta_jitter_ms_in||null:e&&e[o].delta_jitter_ms_out||null;r.push(t,t)}return a>2&&r.push(i===p?s&&s[o].delta_jitter_ms_in||null:s&&s[o].delta_jitter_ms_out||null),rt(r,10)},Et=(t,e,s,o,i,a,r,n,l)=>{const _=[],c=n===p?e[r].delta_rtt_ms_in||t.data.delta_rtt_connectivity_ms:e[r].delta_rtt_ms_out||t.data.delta_rtt_connectivity_ms;if(_.push(c,c,c,c),l>1){const t=o&&(o[r].delta_rtt_ms_in||s.data.delta_rtt_connectivity_ms)||null;_.push(t,t)}return l>2&&_.push(n===p?a&&(a[r].delta_rtt_ms_in||i.data.delta_rtt_connectivity_ms)||null:a&&(a[r].delta_jitter_ms_out||i.data.delta_rtt_connectivity_ms)||null),rt(_,100)},Pt=(t,e,s,o,i,a)=>{const r=[],n=i===p?t[o].percent_packets_lost_in:t[o].percent_packets_lost_out;if(r.push(n,n,n,n),a>1){const t=i===p?e&&e[o].percent_packets_lost_in||null:e&&e[o].percent_packets_lost_out||null;r.push(t,t)}return a>2&&r.push(i===p?s&&s[o].percent_packets_lost_in||null:s&&s[o].percent_packets_lost_out||null),rt(r,0)};class $t{constructor(t,e){this._callbacks={onreport:null,onticket:null},this._id=`coltr-${it()}`,this._moduleName=this._id,this._probeId=e,this._config=t,this._exporter=new wt(t),this._state=m,this.registerToPCEvents(),n(this._moduleName,`new collector created for probe ${this._probeId}`)}analyze(t,e,s,o,i){const r=(t=>{const e={pname:"",call_id:"",user_id:"",timestamp:null,count:0,audio:{},video:{},network:{infrastructure:3,selected_candidate_pair_id:"",local_candidate_id:"",local_candidate_type:"",local_candidate_protocol:"",local_candidate_relay_protocol:"",remote_candidate_id:"",remote_candidate_type:"",remote_candidate_protocol:""},data:{total_KBytes_in:0,total_KBytes_out:0,delta_KBytes_in:0,delta_KBytes_out:0,delta_kbs_in:0,delta_kbs_out:0,delta_kbs_bandwidth_in:0,delta_kbs_bandwidth_out:0,delta_rtt_connectivity_ms:null,total_rtt_connectivity_ms:0,total_rtt_connectivity_measure:0},experimental:{time_to_measure_ms:0},passthrough:{}};if(t){const e={...t,audio:{},video:{},data:{...t.data},network:{...t.network},experimental:{...t.experimental},passthrough:{}};return Object.keys(t.audio).forEach((s=>{e.audio[s]={...t.audio[s]}})),Object.keys(t.video).forEach((s=>{e.video[s]={...t.video[s]}})),e}return{...e,audio:{},video:{},data:{...e.data},network:{...e.network},experimental:{...e.experimental}}})(e);let n=null;return t.forEach((s=>{!n&&s.timestamp&&(n=s.timestamp);const l=((t,e,s,o,i,r)=>{if(!t)return[];switch(a("extractor   ",`analyze() - got stats ${t.type} for ${s}`,t),t.type){case"candidate-pair":let s=!1,a=!1;if(i.has(t.transportId)&&i.get(t.transportId).selectedCandidatePairId===t.id&&(a=!0),q in t&&t.selected&&(s=!0),a||s){const i=t.localCandidateId,a=t.remoteCandidateId,r=t.id,n=((t,e,s)=>{const o=(t.bytesReceived||0)/1024-(s?s.data.total_KBytes_in:0),i=(t.bytesSent||0)/1024-(s?s.data.total_KBytes_out:0),a=t.timestamp||Date.now(),r=o-e.data.total_KBytes_in,n=i-e.data.total_KBytes_out,l=s?s.timestamp:null;let _=e.timestamp;!_&&l&&(_=l);const c=_?a-_:0;return{total_KBytes_received:o,total_KBytes_sent:i,delta_KBytes_received:r,delta_KBytes_sent:n,kbs_speed_received:c>0?.008*r*1024/c*1e3:0,kbs_speed_sent:c>0?.008*n*1024/c*1e3:0}})(t,e,o),l=(t=>({kbs_incoming_bandwidth:t.availableIncomingBitrate/1024||0,kbs_outgoing_bandwidth:t.availableOutgoingBitrate/1024||0}))(t),_=((t,e,s,o)=>{if(!Object.prototype.hasOwnProperty.call(t,R))return{rtt:null,totalRTT:o.data.total_rtt_connectivity_ms,totalRTTMeasurements:o.data.total_rtt_connectivity_measure};const i=Number(1e3)*Number(t.currentRoundTripTime);let a=o.data.total_rtt_connectivity_ms+i,r=o.data.total_rtt_connectivity_measure+1;return Object.prototype.hasOwnProperty.call(t,H)&&(a=Number(1e3)*Number(t.totalRoundTripTime)-(s?s.data.total_rtt_connectivity_ms:0)),Object.prototype.hasOwnProperty.call(t,A)&&(r=Number(t.responsesReceived)-(s?s.data.total_rtt_connectivity_measure:0)),{rtt:i,totalRTT:a,totalRTTMeasurements:r}})(t,0,o,e),c=[{type:et,value:{local_candidate_id:i}},{type:et,value:{remote_candidate_id:a}},{type:st,value:{total_KBytes_in:n.total_KBytes_received}},{type:st,value:{total_KBytes_out:n.total_KBytes_sent}},{type:st,value:{delta_KBytes_in:n.delta_KBytes_received}},{type:st,value:{delta_KBytes_out:n.delta_KBytes_sent}},{type:st,value:{delta_kbs_in:n.kbs_speed_received}},{type:st,value:{delta_kbs_out:n.kbs_speed_sent}},{type:st,value:{delta_kbs_bandwidth_in:l.kbs_incoming_bandwidth}},{type:st,value:{delta_kbs_bandwidth_out:l.kbs_outgoing_bandwidth}},{type:st,value:{delta_rtt_connectivity_ms:_.rtt}},{type:st,value:{total_rtt_connectivity_ms:_.totalRTT}},{type:st,value:{total_rtt_connectivity_measure:_.totalRTTMeasurements}}];return s&&c.push({type:et,internal:"selectedPairChanged",value:{selected_candidate_pair_id:r}}),c}break;case"local-candidate":if(t.id===e.network.local_candidate_id)return[{type:et,value:{infrastructure:Tt(t)}},{type:et,value:{local_candidate_type:t.candidateType||""}},{type:et,value:{local_candidate_protocol:t.protocol||""}},{type:et,value:{local_candidate_relay_protocol:St(t)}}];break;case"remote-candidate":if(t.id===e.network.remote_candidate_id)return[{type:et,value:{remote_candidate_type:t.candidateType||""}},{type:et,value:{remote_candidate_protocol:t.protocol||""}}];break;case w:{const s=t.ssrc,i=vt(s,e,p);i&&(i.timestamp=e.timestamp);const a=vt(s,o,p);if(a&&(a.timestamp=o.timestamp),t.mediaType===V){const e=Ot(t,V,i,a),o=xt(t,V,i),r=t.codecId||"",n=t.audioLevel||0;return[{ssrc:s,type:Z,value:{codec_id_in:r}},{ssrc:s,type:Z,value:{total_packets_in:e.packetsReceived}},{ssrc:s,type:Z,value:{delta_packets_in:e.deltaPacketsReceived}},{ssrc:s,type:Z,value:{total_packets_lost_in:e.packetsLost}},{ssrc:s,type:Z,value:{delta_packets_lost_in:e.deltaPacketsLost}},{ssrc:s,type:Z,value:{percent_packets_lost_in:e.percentPacketsLost}},{ssrc:s,type:Z,value:{total_KBytes_in:e.KBytesReceived}},{ssrc:s,type:Z,internal:"bytesReceivedChanged",value:{delta_KBytes_in:e.deltaKBytesReceived}},{ssrc:s,type:Z,value:{delta_kbs_in:e.kbsReceived}},{ssrc:s,type:Z,value:{delta_jitter_ms_in:o}},{ssrc:s,type:Z,value:{track_in:t.trackIdentifier}},{ssrc:s,type:Z,value:{level_in:n}}]}if(t.mediaType===Q){const e=((t,e)=>{if(!Object.prototype.hasOwnProperty.call(t,T)||!Object.prototype.hasOwnProperty.call(t,G))return{delta_ms_decode_frame:e.video.delta_ms_decode_frame_in,frames_decoded:e.video.total_frames_decoded_in,total_decode_time:e.video.total_time_decoded_in};const s=t.framesDecoded,o=t.totalDecodeTime,i=o-e.video.total_time_decoded_in,a=s-e.video.total_frames_decoded_in;return{delta_ms_decode_frame:a>0?1e3*i/a:0,frames_decoded:s,total_decode_time:o}})(t,i),o=Ot(t,Q,i,a),r=xt(t,Q,i),n=t.decoderImplementation||null,l=t.codecId||null,_=Lt(t),c=((t,e,s)=>{if(!Object.prototype.hasOwnProperty.call(t,U)||!Object.prototype.hasOwnProperty.call(t,$))return{pliCount:e.total_pli_sent_in,nackCount:e.total_nack_sent_in,deltaPliCount:0,deltaNackCount:0};const o=(t.pliCount||0)-(s?s.video.total_pli_sent_in:0),i=(t.nackCount||0)-(s?s.video.total_nack_sent_in:0);return{pliCount:o,nackCount:i,deltaPliCount:o-e.video.total_pli_sent_in,deltaNackCount:i-e.video.total_nack_sent_in}})(t,i,a),u=((t,e,s,o)=>{if(!Object.prototype.hasOwnProperty.call(t,K)||!Object.prototype.hasOwnProperty.call(t,z))return{freezeCount:s.video.total_glitch_in.freeze,pauseCount:s.video.total_glitch_in.pause,deltaFreezeCount:0,deltaPauseCount:0};const i=(t.freezeCount||0)-(o?o.video.total_glitch_in.freeze:0),a=(t.pauseCount||0)-(o?o.video.total_glitch_in.pause:0);return{freezeCount:i,pauseCount:a,deltaFreezeCount:i-s.video.total_glitch_in.freeze,deltaPauseCount:a-s.video.total_glitch_in.pause}})(t,0,i,a);return[{ssrc:s,type:tt,value:{codec_id_in:l}},{ssrc:s,type:tt,value:{total_packets_in:o.packetsReceived}},{ssrc:s,type:tt,value:{delta_packets_in:o.deltaPacketsReceived}},{ssrc:s,type:tt,value:{total_packets_lost_in:o.packetsLost}},{ssrc:s,type:tt,value:{delta_packets_lost_in:o.deltaPacketsLost}},{ssrc:s,type:tt,value:{percent_packets_lost_in:o.percentPacketsLost}},{ssrc:s,type:tt,value:{total_KBytes_in:o.KBytesReceived}},{ssrc:s,type:tt,internal:"bytesReceivedChanged",value:{delta_KBytes_in:o.deltaKBytesReceived}},{ssrc:s,type:tt,value:{delta_kbs_in:o.kbsReceived}},{ssrc:s,type:tt,value:{delta_jitter_ms_in:r}},{ssrc:s,type:tt,value:{decoder_in:n}},{ssrc:s,type:tt,value:{delta_ms_decode_frame_in:e.delta_ms_decode_frame}},{ssrc:s,type:tt,value:{total_frames_decoded_in:e.frames_decoded}},{ssrc:s,type:tt,value:{total_time_decoded_in:e.total_decode_time}},{ssrc:s,type:tt,value:{total_nack_sent_in:c.nackCount}},{ssrc:s,type:tt,value:{delta_nack_sent_in:c.deltaNackCount}},{ssrc:s,type:tt,value:{total_pli_sent_in:c.pliCount}},{ssrc:s,type:tt,value:{delta_pli_sent_in:c.deltaPliCount}},{ssrc:s,type:tt,value:{size_in:_},internal:"inputSizeChanged"},{ssrc:s,type:tt,value:{track_in:t.trackIdentifier}},{ssrc:s,type:tt,value:{total_glitch_in:{freeze:u.freezeCount,pause:u.pauseCount},delta_glitch_in:{freeze:u.deltaFreezeCount,pause:u.deltaPauseCount}},internal:"glitchChanged"}]}break}case"outbound-rtp":{const s=!!t.mediaSourceId,a=t.ssrc,n=vt(a,e,h);n&&(n.timestamp=e.timestamp);const l=vt(a,o,h);l&&(l.timestamp=o.timestamp);let _="",c=0,u={width:0,height:0,framerate:0};if(s&&i.has(t.mediaSourceId)){const e=i.get(t.mediaSourceId);_=e.trackIdentifier,t.kind===V?c=e.audioLevel:u={width:e.width||null,height:e.height||null,framerate:e.framesPerSecond||null}}let d="";if(_){const t=((t,e)=>{const s=e.getSenders().find((e=>e.track&&e.track.id===t));if(s)return s.track;const o=e.getReceivers().find((e=>e.track&&e.track.id===t));return o?o.track:null})(_,r);t&&(d=t.label)}if(t.mediaType===V){const e=t.codecId||null;if(!_){const t=yt("audio",r);t&&(_=t.id,d=t.label)}const o=Rt(t,V,n,l);return[{ssrc:a,type:Z,internal:"mediaSourceUpdated",value:{active_out:s}},{ssrc:a,type:Z,value:{device_out:d}},{ssrc:a,type:Z,value:{codec_id_out:e}},{ssrc:a,type:Z,value:{total_packets_out:o.packetsSent}},{ssrc:a,type:Z,value:{delta_packets_out:o.deltaPacketsSent}},{ssrc:a,type:Z,value:{total_KBytes_out:o.KBytesSent}},{ssrc:a,type:Z,internal:"bytesSentChanged",value:{delta_KBytes_out:o.deltaKBytesSent}},{ssrc:a,type:Z,value:{delta_kbs_out:o.kbsSent}},{ssrc:a,type:Z,internal:"deviceChanged",value:{track_out:_}},{ssrc:a,type:Z,value:{level_out:c}}]}if(t.mediaType===Q){const e=t.encoderImplementation||null,o=t.codecId||null;if(!_){const t=yt("video",r);t&&(_=t.id,d=t.label)}const i=((t,e)=>{if(!Object.prototype.hasOwnProperty.call(t,L)||!Object.prototype.hasOwnProperty.call(t,W))return{delta_ms_encode_frame:e.video.delta_ms_encode_frame_out,frames_encoded:e.video.total_frames_encoded_out,total_encode_time:e.video.total_time_encoded_out};const s=t.framesEncoded,o=t.totalEncodeTime,i=o-e.video.total_time_encoded_out,a=s-e.video.total_frames_encoded_out;return{delta_ms_encode_frame:a>0&&i?1e3*i/a:0,frames_encoded:s,total_encode_time:o}})(t,n),c=Lt(t),p=(t=>{const e=Object.prototype.hasOwnProperty.call(t,j)?t.qualityLimitationReason:null,s=Object.prototype.hasOwnProperty.call(t,E)?t.qualityLimitationResolutionChanges:null,o=Object.prototype.hasOwnProperty.call(t,N)?t.qualityLimitationDurations:null;return o&&Object.keys(o).forEach((t=>{o[t]>1e3&&(o[t]=Number(o[t]/1e3))})),{reason:e,durations:o,resolutionChanges:s}})(t),h=((t,e,s)=>{if(!Object.prototype.hasOwnProperty.call(t,U)||!Object.prototype.hasOwnProperty.call(t,$))return{pliCount:e.total_pli_received_out,nackCount:e.total_nack_received_out,deltaPliCount:0,deltaNackCount:0};const o=(t.pliCount||0)-(s?s.video.total_pli_received_out:0),i=(t.nackCount||0)-(s?s.video.total_nack_received_out:0);return{pliCount:o,nackCount:i,deltaPliCount:o-e.video.total_pli_received_out,deltaNackCount:i-e.video.total_nack_received_out}})(t,n,l),m=Rt(t,Q,n,l);return[{ssrc:a,type:tt,internal:"mediaSourceUpdated",value:{active_out:s}},{ssrc:a,type:tt,value:{device_out:d}},{ssrc:a,type:tt,value:{codec_id_out:o}},{ssrc:a,type:tt,value:{total_packets_out:m.packetsSent}},{ssrc:a,type:tt,value:{delta_packets_out:m.deltaPacketsSent}},{ssrc:a,type:tt,value:{total_KBytes_out:m.KBytesSent}},{ssrc:a,type:tt,internal:"bytesSentChanged",value:{delta_KBytes_out:m.deltaKBytesSent}},{ssrc:a,type:tt,value:{delta_kbs_out:m.kbsSent}},{ssrc:a,type:tt,value:{encoder_out:e}},{ssrc:a,type:tt,value:{delta_ms_encode_frame_out:i.delta_ms_encode_frame}},{ssrc:a,type:tt,value:{total_frames_encoded_out:i.frames_encoded}},{ssrc:a,type:tt,value:{total_time_encoded_out:i.total_encode_time}},{ssrc:a,type:tt,value:{total_nack_received_out:h.nackCount}},{ssrc:a,type:tt,value:{delta_nack_received_out:h.deltaNackCount}},{ssrc:a,type:tt,value:{total_pli_received_out:h.pliCount}},{ssrc:a,type:tt,value:{delta_pli_received_out:h.deltaPliCount}},{ssrc:a,type:tt,value:{size_out:c},internal:"outputSizeChanged"},{ssrc:a,type:tt,value:{limitation_out:p},internal:"videoLimitationChanged"},{ssrc:a,type:tt,internal:"deviceChanged",value:{track_out:_}},{ssrc:a,type:tt,value:{size_pref_out:u}}]}break}default:break;case"codec":const n=[];return Object.keys(e.audio).forEach((s=>{const o=e.audio[s];if(o.codec_id_in===t.id||o.codec_id_out===t.id){const e=(t=>({channels:t.channels||null,clock_rate:t.clockRate||null,mime_type:t.mimeType||null,sdp_fmtp_line:t.sdpFmtpLine||null}))(t);t.id===o.codec_id_in?n.push({ssrc:o.ssrc,type:Z,value:{codec_in:e}}):n.push({ssrc:o.ssrc,type:Z,value:{codec_out:e}})}})),Object.keys(e.video).forEach((s=>{const o=e.video[s];if(o.codec_id_in===t.id||o.codec_id_out===t.id){const e=(t=>({clock_rate:t.clockRate||null,mime_type:t.mimeType||null}))(t);t.id===o.codec_id_in?n.push({ssrc:o.ssrc,type:tt,value:{codec_in:e}}):n.push({ssrc:o.ssrc,type:tt,value:{codec_out:e}})}})),n;case"remote-inbound-rtp":{const s=t.ssrc,i=vt(s,e,h),a=vt(s,o,h);if(t.kind===V){const e=Ct(t,V,a,i),o=xt(t,V,i),r=Bt(t,V,i,a);return[{ssrc:s,type:Z,value:{delta_rtt_ms_out:e.rtt}},{ssrc:s,type:Z,value:{total_rtt_ms_out:e.totalRTT}},{ssrc:s,type:Z,value:{total_rtt_measure_out:e.totalRTTMeasurements}},{ssrc:s,type:Z,value:{delta_jitter_ms_out:o}},{ssrc:s,type:Z,value:{timestamp_out:t.timestamp}},{ssrc:s,type:Z,value:{total_packets_lost_out:r.packetsLost}},{ssrc:s,type:Z,value:{delta_packets_lost_out:r.deltaPacketsLost}},{ssrc:s,type:Z,value:{percent_packets_lost_out:r.fractionLost}}]}if(t.kind===Q){const e=Ct(t,Q,a,i),o=xt(t,Q,i),r=Bt(t,Q,i,a);return[{ssrc:s,type:tt,value:{delta_rtt_ms_out:e.rtt}},{ssrc:s,type:tt,value:{total_rtt_ms_out:e.totalRTT}},{ssrc:s,type:tt,value:{total_rtt_measure_out:e.totalRTTMeasurements}},{ssrc:s,type:tt,value:{delta_jitter_ms_out:o}},{ssrc:s,type:tt,value:{timestamp_out:t.timestamp}},{ssrc:s,type:tt,value:{total_packets_lost_out:r.packetsLost}},{ssrc:s,type:tt,value:{delta_packets_lost_out:r.deltaPacketsLost}},{ssrc:s,type:tt,value:{percent_packets_lost_out:r.fractionLost}}]}break}case"remote-outbound-rtp":{const s=t.ssrc,i=vt(s,e,h),a=vt(s,o,h);if(t.kind===V){const e=Ct(t,V,a,i);return[{ssrc:s,type:Z,value:{delta_rtt_ms_in:e.rtt}},{ssrc:s,type:Z,value:{total_rtt_ms_in:e.totalRTT}},{ssrc:s,type:Z,value:{total_rtt_measure_in:e.totalRTTMeasurements}},{ssrc:s,type:Z,value:{timestamp_in:t.timestamp}}]}break}case"transport":{const e=t.selectedCandidatePairId;return[{type:et,internal:"selectedPairChanged",value:{selected_candidate_pair_id:e}}]}}return[]})(s,r,r.pname,o,t,i);l.forEach((t=>{if("internal"in t&&this.doInternalTreatment(t,e,l),t.value&&t.type)if(t.ssrc){let e=r[t.type][t.ssrc];e||(o=t.type,i=s.type,e=o===V?i===w?{...y}:{...f}:i===w?{...g}:{...b},e.ssrc=t.ssrc,r[t.type][t.ssrc]=e),Object.keys(t.value).forEach((s=>{e[s]=t.value[s]}))}else Object.keys(t.value).forEach((e=>{r[t.type][e]=t.value[e]}));var o,i}));const _=((t,e)=>{if(!t)return[];const s=e&&e[t.type]||[],o={};if(s.length>0){const e=t.ssrc||t.id,i=t.kind||"",a=`${t.type}${i?`-${i}`:""}_${e}`;s.forEach((e=>{e in t&&(e in o||(o[e]={}),o[e][a]=t[e])}))}return o})(s,this._config.passthrough);Object.keys(_).forEach((t=>{r.passthrough[t]||(r.passthrough[t]={}),r.passthrough[t]={...r.passthrough[t],..._[t]}}))})),r.pname=this._config.pname,r.call_id=this._config.cid,r.user_id=this._config.uid,r.count=e?e.count+1:1,r.timestamp=n,Object.keys(r.audio).forEach((t=>{const o=r.audio[t];o[o.direction===p?"mos_emodel_in":"mos_model_out"]=((t,e="audio",s,o,i,a="inbound",r=3)=>{const{currentSSRCReport:n,previousSSRCReport:l,beforeLastSSRCReport:_}=jt(i,t,s,o,a),c=Pt(n,l,_,e,a,r),u=Et(t,n,s,l,o,_,e,a,r),d=Nt(n,l,_,e,a,r),p=Math.max(0,93.2-c),h=(u+d)/2;return Kt(.18*p*p-27.9*p+1126.62-(.024*h+.11*(h-177.3)*(h-177.3<0?0:1)),c>30)})(r,V,e,s,o.ssrc,o.direction,3),o[o.direction===p?"mos_in":"mos_out"]=((t,e="audio",s,o,i,a="inbound",r=3)=>{const{currentSSRCReport:n,previousSSRCReport:l,beforeLastSSRCReport:_}=jt(i,t,s,o,a),c=Pt(n,l,_,e,a,r),u=(Et(t,n,s,l,o,_,e,a,r)+Nt(n,l,_,e,a,r))/2+30,d=.024*u+.11*(u-177.3)*(u-177.3<0?0:1),p=0+19.8*Math.log(1+29.7*c);return Kt(93.2-(p+d))})(r,V,e,s,o.ssrc,o.direction,3),o[o.direction===p?"mos_fullband_in":"mos_fullband_out"]=((t,e="audio",s,o,i,a="inbound",r=3)=>{let n=0;const{currentSSRCReport:l,previousSSRCReport:_,beforeLastSSRCReport:c}=jt(i,t,s,o,a),u=Pt(l,_,c,e,a,r),d=(Et(t,l,s,_,o,c,e,a,r)+Nt(l,_,c,e,a,r))/2,p=10.2+u/(u+4.3)*121.8;if(d>100){const t=(Math.log(d)-Math.log(100))/Math.log(2);n=37*((1+t**6)**(1/6)-3*(1+(t/3)**6)**(1/6)+2)}return Kt((148-n-p+0)/1.48)})(r,V,e,s,o.ssrc,o.direction,3)})),r}doInternalTreatment(t,e,s){const o=(e,s,o=!1)=>o?t.type in s&&e in s[t.type]?s[t.type][e]:null:t.type in s&&t.ssrc in s[t.type]&&e in s[t.type][t.ssrc]?s[t.type][t.ssrc][e]:null,i=(t,e)=>e.find((e=>t in e.value?e.value[t]:null)),a=a=>{const r=t.value[a],n=o(a,e),l=i("device_out",s),_=o("device_out",e);let c="track-stop";if(n!==r){let e=`The existing outbound ${t.type} stream from ${_||"unknown"} has been stopped or muted`;r&&n?(e=`The existing outbound ${t.type} device has been changed to ${l?l.value.device_out:"unknown"}`,c="track-change"):n||(e=`A new outbound ${t.type} stream from ${l?l.value.device_out:"unknown"} has been started or unmuted`,c="track-start"),this.addCustomEvent((new Date).toJSON(),"call",c,e,{ssrc:t.ssrc,value:r,value_old:n,kind:t.type,direction:"outbound"})}},r=a=>{const r=t.value[a],n=o(a,e);(!a.includes("out")||i("active_out",s))&&(n&&n.width===r.width||this.addCustomEvent((new Date).toJSON(),"quality",!n||n.width<r.width?"size-up":"size-down",`The resolution of the ${a.includes("out")?"outbound":"inbound"} ${t.type} stream has ${!n||n.width<r.width?"increased":"decreased"} to ${r.width}x${r.height}`,{direction:a.includes("out")?"outbound":"inbound",ssrc:t.ssrc,kind:t.type,value:`${r.width}x${r.height}`,value_old:`${n?n.width:0}x${n?n.height:0}`}),(!n||void 0!==n.framerate&&Math.abs(n.framerate-r.framerate)>2)&&this.addCustomEvent((new Date).toJSON(),"quality",!n||n.framerate<r.framerate?"fps-up":"fps-down",`The framerate of the ${a.includes("out")?"outbound":"inbound"} ${t.type} stream has ${!n||n.framerate<r.framerate?"increased":"decreased"} to ${r.framerate}`,{direction:a.includes("out")?"outbound":"inbound",kind:t.type,ssrc:t.ssrc,value:r.framerate,value_old:n?n.framerate:0}))},n=s=>{const i=t.value[s],a=o(s,e);i!==a&&this.addCustomEvent((new Date).toJSON(),"call",i?"track-active":"track-inactive",`The ${s.includes("out")?"outbound":"inbound"} ${t.type} stream switched to ${i?"active":"inactive"}`,{direction:s.includes("out")?"outbound":"inbound",kind:t.type,ssrc:t.ssrc,value:i,value_old:a})},l=s=>{const i=t.value[s],a=o(s,e);a&&i.reason===a.reason||this.addCustomEvent((new Date).toJSON(),"quality","none"===i.reason?"unlimited":i.reason,"The outbound video stream resolution is "+("none"===i.reason?"no more limited":`limited due to ${i.reason} reason`),{direction:s.includes("out")?"outbound":"inbound",kind:t.type,ssrc:t.ssrc,value:i.reason,value_old:a})},_=a=>{const r=t.value[a],n=o(a,e),l=10*n;(!a.includes("out")||i("active_out",s))&&(r>l||r<n/10)&&this.addCustomEvent((new Date).toJSON(),"quality",r>l?"peak-up":"peak-down",`A peak has been detected for the ${a.includes("out")?"outbound":"inbound"} ${t.type} steam. Could be linked to a ${r>l?"unmute":"mute"}`,{direction:a.includes("out")?"outbound":"inbound",kind:t.type,ssrc:t.ssrc,peak:r>l?"up":"down",value:r,value_old:n})},c=s=>{const i=t.value[s],a=o(s,e,!0);i!==a&&this.addCustomEvent((new Date).toJSON(),"signal","route-change",`The selected candidates pair changed to ${i}`,{value:i,value_old:a})};if(e)switch(t.internal){case"deviceChanged":a("track_out");break;case"inputSizeChanged":r("size_in");break;case"outputSizeChanged":r("size_out");break;case"bytesSentChanged":_("delta_KBytes_out");break;case"bytesReceivedChanged":_("delta_KBytes_in");break;case"mediaSourceUpdated":n("active_out");break;case"videoLimitationChanged":l("limitation_out");break;case"selectedPairChanged":c("selected_candidate_pair_id")}}async takeReferenceStats(){return new Promise(((t,e)=>{const s=Date.now();setTimeout((async()=>{try{const e=Date.now()-s,o=Date.now(),i=await this._config.pc.getStats(),r=this.analyze(i,null,null,null,this._config.pc),n=Date.now();r.experimental.time_to_measure_ms=n-o,r.experimental.time_to_wait_ms=e,this._exporter.saveReferenceReport(r),a(this._moduleName,`got reference report for probe ${this._probeId}`),t()}catch(t){e(t)}}),this._config.startAfter)}))}async collectStats(){try{if(this._state!==v||!this._config.pc)return a(this._moduleName,`report discarded (too late) for probe ${this._probeId}`),null;const t=Date.now(),e=await this._config.pc.getStats(),s=this.analyze(e,this._exporter.getLastReport(),this._exporter.getBeforeLastReport(),this._exporter.getReferenceReport(),this._config.pc),o=Date.now();return s.experimental.time_to_measure_ms=o-t,this._exporter.addReport(s),a(this._moduleName,`got report for probe ${this._probeId}#${this._exporter.getReportsNumber()+1}`),this.fireOnReport(s),s}catch(t){return _(this._moduleName,`got error ${t}`),null}}async start(){a(this._moduleName,"starting"),this.state=v,this._startedTime=this._exporter.start(),a(this._moduleName,"started")}async mute(){this.state="muted",a(this._moduleName,"muted")}async unmute(){this.state=v,a(this._moduleName,"unmuted")}async stop(t){if(a(this._moduleName,`stopping${t?" by watchdog":""}...`),this._stoppedTime=this._exporter.stop(),this.state=m,this._config.ticket){const{ticket:t}=this._exporter;this.fireOnTicket(t)}this._exporter.reset(),a(this._moduleName,"stopped")}registerCallback(t,e,s){t in this._callbacks?(this._callbacks[t]={callback:e,context:s},a(this._moduleName,`registered callback '${t}'`)):_(this._moduleName,`can't register callback for '${t}' - not found`)}unregisterCallback(t){t in this._callbacks?(this._callbacks[t]=null,delete this._callbacks[t],a(this._moduleName,`unregistered callback '${t}'`)):_(this._moduleName,`can't unregister callback for '${t}' - not found`)}fireOnReport(t){this._callbacks.onreport&&lt(this._callbacks.onreport.callback,this._callbacks.onreport.context,t)}fireOnTicket(t){this._callbacks.onticket&&lt(this._callbacks.onticket.callback,this._callbacks.onticket.context,t)}updateConfig(t){this._config=t,this._exporter.updateConfig(t)}get state(){return this._state}set state(t){this._state=t,a(this._moduleName,`state changed to ${t}`)}addCustomEvent(t,e,s,o,i){this._exporter.addCustomEvent({at:"object"==typeof t?t.toJSON():t,category:e,name:s,description:o,data:i})}async registerToPCEvents(){const{pc:t}=this._config;navigator.mediaDevices.ondevicechange=async()=>{try{const t=await navigator.mediaDevices.enumerateDevices();this.addCustomEvent((new Date).toJSON(),"device","device-change","One device (at least) has been plugged or unplugged",{count:t.length})}catch(t){_(this._moduleName,"can't get devices")}},t&&(t.oniceconnectionstatechange=()=>{const e=t.iceConnectionState;this.addCustomEvent((new Date).toJSON(),"signal","ice-change",`The ICE connection state has changed to ${e}`,{state:e,type:"icestate"})},t.onconnectionstatechange=()=>{const e=t.connectionState;this.addCustomEvent((new Date).toJSON(),"signal","connection-change",`The connection state has changed to ${e}`,{state:e,type:"connection"})},t.onicegatheringstatechange=()=>{const e=t.iceGatheringState;this.addCustomEvent((new Date).toJSON(),"signal","gathering-change",`The ICE gathering state has changed to ${e}`,{state:e,type:"gathering"})},t.ontrack=t=>{this.addCustomEvent((new Date).toJSON(),"call","track-received",`A new inbound ${t.track.kind} stream has been started`,{kind:t.track.kind,label:t.track.label,id:t.track.id,direction:"inbound"})},t.onnegotiationneeded=()=>{this.addCustomEvent((new Date).toJSON(),"signal","ice-negotiation","A negotiation is required",{type:"negotiation"})})}}class It{constructor(t){this._id=t.pname&&t.pname.substr(0,12).padEnd(12," ")||`probe-${it()}`,this._moduleName=this._id,n(this._moduleName,"probe created"),this._config=t,this._collector=new $t(this._config,this._id)}set onreport(t){t?this._collector.registerCallback("onreport",t):this._collector.unregisterCallback("onreport")}set onticket(t){t?this._collector.registerCallback("onticket",t):this._collector.unregisterCallback("onticket")}get id(){return this._id}get pname(){return this._config.pname}get cid(){return this._config.cid}get uid(){return this._config.uid}get state(){return this._collector.state}set state(t){this._collector.state=t}addCustomEvent(t,e,s,o=(new Date).toJSON()){this._collector.addCustomEvent(o,e,t,s)}get isRunning(){return this._collector.state===v}get isIdle(){return this._collector.state===m}updateUserId(t){this._config.uid=t,this._collector.updateConfig(this._config)}updateCallId(t){this._config.cid=t,this._collector.updateConfig(this._config)}start(){this.isIdle?this._collector.start():l(this._moduleName,"probe is already running")}stop(t=!1){this.isRunning&&this._collector.stop(t)}async takeReferenceStats(){return this._collector.takeReferenceStats()}async collectStats(){return this._collector.collectStats()}}const Dt="engine      ";class Mt{constructor(t){this._config=t,this._probes=[],this._startedTime=null,this._callbacks={onresult:null},n(Dt,`configured for probing every ${this._config.refreshEvery}ms`),n(Dt,`configured for starting after ${this._config.startAfter}ms`),n(Dt,this._config.stopAfter&&-1===this._config.stopAfter?"configured for never stopped":`configured for stopped after ${this._config.stopAfter}ms`),a(Dt,"engine initialized")}get probes(){return this._probes}get isRunning(){return this._probes.some((t=>t.isRunning))}get isIdle(){return this._probes.every((t=>t.isIdle))}addNewProbe(t,e){if(!t)throw new Error("undefined peer connection");const s=((t,e={},s)=>{const o={...s,...e};return e.pname||l(ot,`Argument [String] 'cfg.pname' for the peerConnection name or id is missing - use generated '${s.pname}'`),e.cid||l(ot,`Argument [String] 'cfg.cid' for the call name or id is missing - use generated '${s.cid}'`),e.uid||l(ot,`Argument [String] 'cfg.uid' for the user name or id is missing - use generated '${s.uid}'`),o.pc=t,o})(t,e,this._config),o=new It(s);return this._probes.push(o),a(Dt,`${this._probes.length} probes registered`),o}removeExistingProbe(t){if(!t)throw new Error("undefined probe");t.state===v&&t.stop(),this._probes=this._probes.filter((e=>t.id!==e.id))}async start(){const t=()=>!this.isIdle&&(!this._config.stopAfter||this._config.stopAfter<0||Date.now()<this._startedTime+this._config.stopAfter),e=async()=>{const t={delta_time_to_measure_probes_ms:0,delta_time_consumed_to_measure_ms:0,delta_KBytes_in:0,delta_KBytes_out:0,delta_kbs_in:0,delta_kbs_out:0,total_time_decoded_in:0,total_time_encoded_out:0,probes:[]},e=this._probes.filter((t=>t.isRunning));for(const s of e){const e=await s.collectStats();e&&t.probes.push(e),a(Dt,`got probe ${s.id}`),await nt(0)}return t.delta_time_to_measure_probes_ms=ut(t.probes,"experimental","time_to_measure_ms"),t.delta_KBytes_in=ut(t.probes,"data","delta_KBytes_in"),t.delta_KBytes_out=ut(t.probes,"data","delta_KBytes_out"),t.delta_kbs_in=ut(t.probes,"data","delta_kbs_in"),t.delta_kbs_out=ut(t.probes,"data","delta_kbs_out"),t.total_time_decoded_in=ut(t.probes,"video","total_time_decoded_in"),t.total_time_encoded_out=ut(t.probes,"video","total_time_encoded_out"),t};for(a(Dt,"starting to collect"),(()=>{this._probes.forEach((t=>t.start()))})(),a(Dt,"generating reference reports..."),await(async()=>Promise.all(this._probes.map((t=>t.takeReferenceStats()))))(),a(Dt,"reference reports generated"),this._startedTime=Date.now();t();)if(a(Dt,`wait ${this._config.refreshEvery}ms before collecting`),await nt(this._config.refreshEvery),t()){a(Dt,"collecting...");const t=Date.now(),s=await e(),o=Date.now();s.delta_time_consumed_to_measure_ms=o-t,this.fireOnReports(s),a(Dt,"collected")}a(Dt,"reaching end of the collecting period..."),this.isRunning&&setTimeout((()=>{this.stop()}),0)}stop(t){n(Dt,"stop collecting"),(t=>{this._probes.forEach((e=>{e.stop(t)}))})(t)}registerCallback(t,e,s){t in this._callbacks?(this._callbacks[t]={callback:e,context:s},a(Dt,`registered callback '${t}'`)):_(Dt,`can't register callback for '${t}' - not found`)}unregisterCallback(t){t in this._callbacks?(this._callbacks[t]=null,delete this._callbacks[t],a(this._moduleName,`unregistered callback '${t}'`)):_(this._moduleName,`can't unregister callback for '${t}' - not found`)}fireOnReports(t){this._callbacks.onresult&&t.probes.length>0&&lt(this._callbacks.onresult.callback,this._callbacks.onresult.context,t)}}class Ft{constructor(s){var o;this._config=((t={})=>{const e={...k,...t};return e.name="WebRTCMetrics",e.version="5.3.1",e})(s),n("interface   ",`welcome to ${this._config.name} version ${this._config.version}`),o=this._config.verbose||!1,t.info(i(e(),"log         ","set log level to "+(o?"verbose":"info"))),t.setLevel(o?t.levels.TRACE:t.levels.INFO),this._engine=new Mt(this._config)}setupLogLevel(s){(s=>{const o=[...Object.keys(t.levels)];o.includes(s)?(t.info(i(e(),"log         ",`update log level to ${s.toLowerCase()}`)),t.setLevel(s)):t.warn(i(e(),"log         ","Incorrect log level please choose one of "),o)})(s)}get version(){return this._config.version}get name(){return this._config.name}get probes(){return this._engine.probes}createProbe(t,e){return this._engine.addNewProbe(t,e)}startAllProbes(){this._engine.start()}stopAllProbes(){this._engine.stop()}get running(){return this._engine.isRunning}get idle(){return this._engine.isIdle}removeProbe(t){this._engine.removeExistingProbe(t)}set onresult(t){t?this._engine.registerCallback("onresult",t):this._engine.unregisterCallback("onresult")}}})(),o.default})()}));